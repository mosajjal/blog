<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=content-security-policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self'; child-src 'self'; font-src 'self' disqus.com disquscdn.com *.disqus.com *.disquscdn.com; form-action 'self' https://syndication.twitter.com/ https://platform.twitter.com disqus.com disquscdn.com *.disqus.com *.disquscdn.com; frame-src 'self' https://cse.google.com https://player.vimeo.com www.youtube.com www.youtube-nocookie.com https://platform.twitter.com https://syndication.twitter.com  jsfiddle.net www.instagram.com https://kuula.co https://www.slideshare.net https://www.google.com disqus.com disquscdn.com *.disqus.com *.disquscdn.com; img-src 'self' https://jeremylikness.visualstudio.com *.gstatic.com *.amazon-adsystem.com https://www.googleapis.com https://images-na.ssl-images-amazon.com https://platform.twitter.com *.twimg.com https://syndication.twitter.com data: https://files.kuula.io disqus.com disquscdn.com *.disqus.com *.disquscdn.com; object-src 'none'; style-src 'self' 'unsafe-inline' https://use.fontawesome.com https://fonts.googleapis.com https://www.google.com https://platform.twitter.com *.twimg.com disqus.com disquscdn.com *.disqus.com *.disquscdn.com; script-src 'self' 'unsafe-inline' https://platform.twitter.com https://static.cloudflareinsights.com disqus.com disquscdn.com *.disqus.com *.disquscdn.com; prefetch-src 'self' 'unsafe-inline' https://platform.twitter.com https://static.cloudflareinsights.com disqus.com disquscdn.com *.disqus.com *.disquscdn.com; connect-src 'self' 'unsafe-inline' https://platform.twitter.com https://static.cloudflareinsights.com disqus.com disquscdn.com *.disqus.com *.disquscdn.com;">
<meta name=keywords content="[Infosec Blue Team Linux]">
<meta name=robots content="noodp">
<meta http-equiv=x-ua-compatible content="IE=edge, chrome=1">
<title>Basic guidelines that would've prevented SUNBURST - n0p Blog</title><meta name=Description content="Sunburst overview and next steps"><meta property="og:title" content="Basic guidelines that would've prevented SUNBURST">
<meta property="og:description" content="Sunburst overview and next steps">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.n0p.me/2020/12/2021-12-28-sunburst-defend/"><meta property="og:image" content="https://blog.n0p.me/img/sunburst-defend/sunburst-oj.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2020-12-28T00:00:00+00:00">
<meta property="article:modified_time" content="2020-12-28T00:00:00+00:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://blog.n0p.me/img/sunburst-defend/sunburst-oj.png">
<meta name=twitter:title content="Basic guidelines that would've prevented SUNBURST">
<meta name=twitter:description content="Sunburst overview and next steps">
<meta name=application-name content="n0p Blog">
<meta name=apple-mobile-web-app-title content="n0p Blog"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.n0p.me/2020/12/2021-12-28-sunburst-defend/><link rel=prev href=https://blog.n0p.me/2020/10/2020-10-13-malware-applocker-bypass/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Basic guidelines that would've prevented SUNBURST","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.n0p.me\/2020\/12\/2021-12-28-sunburst-defend\/"},"genre":"posts","keywords":"sunburst, SolarWinds, Infosec","wordcount":1571,"url":"https:\/\/blog.n0p.me\/2020\/12\/2021-12-28-sunburst-defend\/","datePublished":"2020-12-28T00:00:00+00:00","dateModified":"2020-12-28T00:00:00+00:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"Ali Mosajjal"},"author":{"@type":"Person","name":"Ali Mosajjal"},"description":"Sunburst overview and next steps"}</script></head>
<body header-desktop header-mobile><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':''==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:''==='dark')&&document.body.setAttribute('theme','dark')</script>
<div id=mask></div><div class=wrapper><header class=desktop id=header-desktop>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="n0p Blog">n0p Blog</a>
</div>
<div class=menu>
<div class=menu-inner><a class=menu-item href=/posts> Posts </a><a class=menu-item href=/tags> Tags </a><a class=menu-item href=/categories> Categories </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search>
<i class="fas fa-search fa-fw"></i>
</a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear>
<i class="fas fa-times-circle fa-fw"></i>
</a>
<span class="search-button search-loading" id=search-loading-desktop>
<i class="fas fa-spinner fa-fw fa-spin"></i>
</span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i>
</a>
</div>
</div>
</div>
</header><header class=mobile id=header-mobile>
<div class=header-container>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="n0p Blog">n0p Blog</a>
</div>
<div class=menu-toggle id=menu-toggle-mobile>
<span></span><span></span><span></span>
</div>
</div>
<div class=menu id=menu-mobile><div class=search-wrapper>
<div class="search mobile" id=search-mobile>
<input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search>
<i class="fas fa-search fa-fw"></i>
</a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear>
<i class="fas fa-times-circle fa-fw"></i>
</a>
<span class="search-button search-loading" id=search-loading-mobile>
<i class="fas fa-spinner fa-fw fa-spin"></i>
</span>
</div>
<a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>
Cancel
</a>
</div><a class=menu-item href=/posts title>Posts</a><a class=menu-item href=/tags title>Tags</a><a class=menu-item href=/categories title>Categories</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i>
</a></div>
</div>
</header>
<div class="search-dropdown desktop">
<div id=search-dropdown-desktop></div>
</div>
<div class="search-dropdown mobile">
<div id=search-dropdown-mobile></div>
</div>
<main class=main>
<div class=container><div class=toc id=toc-auto>
<h2 class=toc-title>Contents</h2>
<div class=toc-content id=toc-content-auto></div>
</div><article class="page single"><h1 class="single-title animated flipInX">Basic guidelines that would've prevented SUNBURST</h1><div class=post-meta>
<div class=post-meta-line><span class=post-author><a href=/ title=Author rel=" author" class=author><i class="fas fa-user-circle fa-fw"></i>Ali Mosajjal</a></span>&nbsp;<span class=post-category>included in <a href=/categories/security/><i class="far fa-folder fa-fw"></i>security</a>&nbsp;<a href=/categories/infosec/><i class="far fa-folder fa-fw"></i>Infosec</a></span></div>
<div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2020-12-28>2020-12-28</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;1571 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;8 minutes&nbsp;</div>
</div><div class="details toc" id=toc-static kept>
<div class="details-summary toc-title">
<span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span>
</div>
<div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents>
<ul>
<li><a href=#solarwinds-orion>SolarWinds Orion</a></li>
<li><a href=#the-case-of-a-trojan-horse>The case of a Trojan Horse</a></li>
<li><a href=#server-vs-endpoint-internet-access>Server vs Endpoint Internet Access</a></li>
<li><a href=#whats-next>What&rsquo;s Next</a></li>
<li><a href=#what-year-is-it-2010>What year is it, 2010?</a></li>
</ul>
</nav></div>
</div><div class=content id=content><h2 id=solarwinds-orion>SolarWinds Orion</h2>
<p>First off, let&rsquo;s have a brief overview of what SolarWinds Orion is and what&rsquo;s it good for. Orion&rsquo;s main purpose is to give a single pane of glass to look at your IT infrastructure. Various technologies can pump their metrics into Orion Database using Orion poller as a proxy. Orion Pollers will sit in your network, consume the metrics they need, and push it to the database engine. From the design perspective, it&rsquo;s a robust, effective, and scalable way of having the data always ready. Oh btw, SolarWinds has nearly 18,000 customers worldwide.</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=/img/sunburst-defend/orion-overview.png data-srcset="/img/sunburst-defend/orion-overview.png, /img/sunburst-defend/orion-overview.png 1.5x, /img/sunburst-defend/orion-overview.png 2x" data-sizes=auto alt=/img/sunburst-defend/orion-overview.png title=image></p>
<p>If you&rsquo;ve implemented Splunk heavy forwarders, Syslog Servers, Elastic Beats, OSQuery agents, and hundreds of other products, this looks familiar. In <a href=https://documentation.solarwinds.com/en/Success_Center/orionplatform/Content/Core-Agent-Requirements-sw476.htm target=_blank rel="noopener noreffer">their website</a>, SolarWinds has pointed out the security requirements of agents connections to Orion Server on ports 22/TCP, 17778/TCP, and 17790/TCP.</p>
<p>So far so good? let&rsquo;s see where the problem is (hint: as always, it&rsquo;s a human error)</p>
<h2 id=the-case-of-a-trojan-horse>The case of a Trojan Horse</h2>
<p>In a somewhat unknown incident, believed to be before March 2019, someone gained access to the SolarWinds update server. According to <a href=https://www.reuters.com/article/global-cyber-solarwinds/hackers-used-solarwinds-dominance-against-it-in-sprawling-spy-campaign-idINKBN28Q07P target=_blank rel="noopener noreffer">Reuters</a>, Security researcher Vinoth Kumar alerted SolarWinds that anyone could access SolarWinds’ update server by using the password “solarwinds123”. So the assumption is, getting access to the update servers was not difficult in early 2019 or before. Unlucky for the rest of the world, whoever gained access to that update server, didn&rsquo;t use it to install <code>xmrig</code> and mine Monero or join it to a Botnet. Instead, they tried to learn how the CI/CD pipeline works inside SolarWinds. We don&rsquo;t know much detail on that but what we do know is, by March 2019, an update for Orion software had an extra &ldquo;patch&rdquo; in it and it went completely unnoticed by SolarWinds, got signed, and pushed to the mass. I won&rsquo;t copy and paste all the technical details of the DLLs and hashes etc here, since Microsoft nailed it with their series of <a href=https://msrc-blog.microsoft.com/2020/12/13/customer-guidance-on-recent-nation-state-cyber-attacks/ target=_blank rel="noopener noreffer">blogposts</a> on the subject.</p>
<p>Long story short, <code>SolarWinds.Orion.Core.BusinessLayer.dll</code> is now a classic trojan horse. It has a dormant period and after that, it tries to call home (<code>avsvmcloud[.]com</code>) and get instruction, jobs, and so on.</p>
<p>So, we have 18k customers of SolarWinds, most of which would&rsquo;ve updated their product to an infected version, hence having a backdoor in them. That backdoor is self-activating to that one domain and that one domain only. It will ping that domain to get further instructions and possible next &ldquo;stable&rdquo; C2 connection domain for further activity.</p>
<p>What I&rsquo;m trying to wrap my head around is this: why does a close-design ecosystem like SolarWinds Orion is implemented in a way that the Orion agent/software has access to that particular domain?</p>
<h2 id=server-vs-endpoint-internet-access>Server vs Endpoint Internet Access</h2>
<p>It&rsquo;s fairly well-understood that your company laptop&rsquo;s internet gateway shouldn&rsquo;t be the same as your fleet of servers in your Data Centre. I&rsquo;m hoping that we&rsquo;re all on the same page that servers don&rsquo;t need to check their social media account secretly at 10am, but we do. For your internet-facing server fleet, your load-balancers and Firewalls will sit in front of your servers, preventing any outbound connection and only allowing &ldquo;sane&rdquo; traffic to come through, so even if you&rsquo;re web server is literally serving traffic to the entire world, it doesn&rsquo;t need the ability to have direct internet access to any IP at all.</p>
<p>In fact, I would go as far as saying no well-designed server in the world needs direct internet access to the whole IPv4 range. If you have an EC2 instance right now and you&rsquo;re thinking that instance has internet access and I&rsquo;m fine with that, take a look at <a href=https://docs.aws.amazon.com/quickstart/latest/vpc/architecture.html target=_blank rel="noopener noreffer">this</a> architecture design by Amazon.</p>
<p>According to <a href=https://www.microsoft.com/security/blog/2020/12/18/analyzing-solorigate-the-compromised-dll-file-that-started-a-sophisticated-cyberattack-and-how-microsoft-defender-helps-protect/ target=_blank rel="noopener noreffer">Microsoft&rsquo;s technical blog</a>:</p>
<blockquote>
<p>In its first step, the backdoor initiates a connection to a predefined C2 server to report some basic information about the compromised system and receive the first commands.</p>
</blockquote>
<p>Based on what we know so far, it&rsquo;s safe to assume that in every single victim company, there has been at least one Orion installer with full internet access. That includes Cisco, Intel, and a lot of US Government agencies. I wouldn&rsquo;t be surprised if the successful C2 communications came from a cloud instance. By default, a lot of compute nodes within any Cloud environment have unlimited internet access.</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=/img/sunburst-defend/sunburst-victims.png data-srcset="/img/sunburst-defend/sunburst-victims.png, /img/sunburst-defend/sunburst-victims.png 1.5x, /img/sunburst-defend/sunburst-victims.png 2x" data-sizes=auto alt=/img/sunburst-defend/sunburst-victims.png title=image></p>
<p>so, the next logical question is: where does SolarWinds.Orion.Core.BusinessLayer.dll usually sit? Is it found on endpoints or servers? The answer is simple: it almost exclusively sits in servers.</p>
<h2 id=whats-next>What&rsquo;s Next</h2>
<p>I hope that by now my point is very clear. From my point of view, only one thing made this attack stand out among others. The fact that SolarWinds got pwned by an attacker and the attacker was clever enough to use that entry point to inject code. The rest is essentially the same crap that we&rsquo;ve been dealing with for years. That&rsquo;s why we created DMZs and ACLs on our Routers and Switches and Firewalls. We acknowledged a long ago that trusting in &ldquo;one thing&rdquo; is wrong. We&rsquo;ve seen this before and we&rsquo;ll definitely see it again soon. The answer to the question &ldquo;what&rsquo;s next?&rdquo; is pretty boring and predictable, but we&rsquo;ll go through a couple of them relevant to this particular incident.</p>
<ul>
<li>
<p>Servers are not endpoints. They should have an IP allowlist rather than an IP blocklist. They should NOT have access to the internet except for a few allowed CIDRs and domains. Keep in mind that if you&rsquo;re not breaking SSL in your proxy, make sure to whitelist correctly, since domain whitelisting is often unreliable. for example, if the attacker takes over a server that&rsquo;s allowed to access Google.com but with any IP, they can just add their C2 server to the &ldquo;hosts&rdquo; file of the victim as google.com and bypass your restrictions if you&rsquo;re not careful. Also, if you&rsquo;re using a proxy, having a domain allowlist based on source IP + authentication is the best way forward. Unfortunately, you can&rsquo;t rely on authentication only since if the attacker has a foothold inside your network, they can just sniff another set of creds, possibly from an endpoint, and initiate their connectivity with an endpoint profile but from a server IP.</p>
</li>
<li>
<p>Host your own DNS: if you&rsquo;re allowing your endpoints to talk to any DNS servers outside your organization, think again. DNS Tunneling is real and it&rsquo;s a very tough nut to crack when it comes to defense. <a href="https://www.youtube.com/watch?v=CaFo83TlpPM" target=_blank rel="noopener noreffer">This Video</a> provides a good overview of attack and defense tactics for DNS.</p>
</li>
<li>
<p>Avoid flat networks as much as you can: it&rsquo;s hard to count your FW denies if the packets don&rsquo;t reach the FW to be denied. We can&rsquo;t trust our neighbors in the network to not <code>nmap</code> us 24/7. East-west protection and detection is a good step towards a Zero Trust network implementation. Also, if you&rsquo;re in a comfort zone of RFC1918 for your server, and you think nothing bad comes from RFC1918 IPs, you&rsquo;re not thinking of your lateral movement risks.</p>
</li>
<li>
<p>Anomaly Detection vs Traditional SIEM rules: if your server is contacting a new IP or a new domain that you haven&rsquo;t seen in your organization before, that&rsquo;s an alarm. This is a DFIR layer on top of what we already discussed in terms of access control management and IP allow listing. to have the assurance that your FW is doing its job properly, have a rule in place to see if a particular server is connecting to a brand new IP out of the blue. That&rsquo;s a red flag and that&rsquo;s usually how you get ransomware as well. Splunk has a <a href=https://www.splunk.com/en_us/blog/security/finding-new-evil-detecting-new-domains-with-splunk.html target=_blank rel="noopener noreffer">great article</a> for building new domain rules.</p>
</li>
<li>
<p>Patch, patch, patch: &ldquo;but if I didn&rsquo;t patch, I wouldn&rsquo;t have a backdoor-ed version,&rdquo; you say. Well, in this particular incident, yes. but even so, I would rather be attacked (and defend against, by doing my defense in depth) by an attacker that did their homework than a script kitty pulling code from Github and pwning my shit, which is what would happen if you don&rsquo;t patch. Does that make sense?</p>
</li>
</ul>
<h2 id=what-year-is-it-2010>What year is it, 2010?</h2>
<p>I know right? What I just talked about is very well defined and agreed upon within cybersecurity domains, and none of them are radical. Yet, looks like even major companies fall into not having 100% coverage of these simple policies.</p>
<p>Big takeaway is this: servers and endpoints falling off from your Golden standards is a very common theme across organizations, big or small. Best to have a plan to verify and provide assurance of your standards and keep track of those who fall behind. IT is a very fast-paced environment and it&rsquo;s almost impossible to do this manually. Each organization needs to have its own automated way of keeping track of security sanity checks. Hate to be &ldquo;that&rdquo; person, but defense is not all cool forensics and finding tracks of malicious, ephemeral code in RAM. It&rsquo;s keeping the weakest link as secure as you need it to be. If you&rsquo;re seeing a company in the news for ransomware or a massive data breach, I&rsquo;m sure their CISO is thinking &ldquo;but we&rsquo;re 90+% secure&rdquo;, and she/he&rsquo;s right. Odds are their &ldquo;strong&rdquo; sites are ok but some test instance somewhere had a misconfig and fell out of patching cycle and it happens to have some hardcoded creds in a text file, leading to a massive breach.</p>
<p>Keep up with 2021 but bring your y2k stuff forward too, Happy hunting and Merry Christmas.</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=/img/sunburst-defend/rickandmorty.gif data-srcset="/img/sunburst-defend/rickandmorty.gif, /img/sunburst-defend/rickandmorty.gif 1.5x, /img/sunburst-defend/rickandmorty.gif 2x" data-sizes=auto alt=/img/sunburst-defend/rickandmorty.gif title=Rick></p>
</div><div class=post-footer id=post-footer>
<div class=post-info>
<div class=post-info-line>
<div class=post-info-mod>
<span>Updated on 2020-12-28</span>
</div>
<div class=post-info-license></div>
</div>
<div class=post-info-line>
<div class=post-info-md></div>
<div class=post-info-share>
<span></span>
</div>
</div>
</div>
<div class=post-info-more>
<section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/sunburst/>sunburst</a>,&nbsp;<a href=/tags/solarwinds/>SolarWinds</a>,&nbsp;<a href=/tags/infosec/>Infosec</a></section>
<section>
<span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span>
</section>
</div>
<div class=post-nav><a href=/2020/10/2020-10-13-malware-applocker-bypass/ class=prev rel=prev title="Analysis of a Multi-stage Squiblydoo variant"><i class="fas fa-angle-left fa-fw"></i>Analysis of a Multi-stage Squiblydoo variant</a></div>
</div>
<div id=comments><div id=disqus_thread class=comment></div><noscript>
Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.
</noscript></div></article></div>
</main><footer class=footer>
<div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.87.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
</div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2021</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Ali Mosajjal</a></span></div>
</div>
</footer></div>
<div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top">
<i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments">
<i class="fas fa-comment fa-fw"></i>
</a>
</div><script type=text/javascript src=https://n0p-me.disqus.com/embed.js defer></script><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{},search:{highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:30}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-114664513-1',{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=UA-114664513-1" async></script></body>
</html>