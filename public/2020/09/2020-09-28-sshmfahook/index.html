<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=content-security-policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self'; child-src 'self'; font-src 'self' disqus.com disquscdn.com *.disqus.com *.disquscdn.com; form-action 'self' https://syndication.twitter.com/ https://platform.twitter.com disqus.com disquscdn.com *.disqus.com *.disquscdn.com; frame-src 'self' https://cse.google.com https://player.vimeo.com www.youtube.com www.youtube-nocookie.com https://platform.twitter.com https://syndication.twitter.com  jsfiddle.net www.instagram.com https://kuula.co https://www.slideshare.net https://www.google.com disqus.com disquscdn.com *.disqus.com *.disquscdn.com; img-src 'self' https://jeremylikness.visualstudio.com *.gstatic.com *.amazon-adsystem.com https://www.googleapis.com https://images-na.ssl-images-amazon.com https://platform.twitter.com *.twimg.com https://syndication.twitter.com data: https://files.kuula.io disqus.com disquscdn.com *.disqus.com *.disquscdn.com; object-src 'none'; style-src 'self' 'unsafe-inline' https://use.fontawesome.com https://fonts.googleapis.com https://www.google.com https://platform.twitter.com *.twimg.com disqus.com disquscdn.com *.disqus.com *.disquscdn.com; script-src 'self' 'unsafe-inline' https://platform.twitter.com https://static.cloudflareinsights.com disqus.com disquscdn.com *.disqus.com *.disquscdn.com; prefetch-src 'self' 'unsafe-inline' https://platform.twitter.com https://static.cloudflareinsights.com disqus.com disquscdn.com *.disqus.com *.disquscdn.com; connect-src 'self' 'unsafe-inline' https://platform.twitter.com https://static.cloudflareinsights.com disqus.com disquscdn.com *.disqus.com *.disquscdn.com;">
<meta name=keywords content="[Infosec Blue Team Linux]">
<meta name=robots content="noodp">
<meta http-equiv=x-ua-compatible content="IE=edge, chrome=1">
<title>SSH MFA using Slack/Teams/Discord - n0p Blog</title><meta name=Description content="n0p Blog"><meta property="og:title" content="SSH MFA using Slack/Teams/Discord">
<meta property="og:description" content="What is SSH MFA Let&rsquo;s start from the basics. We&rsquo;re all familiar with Multi-Factor Authentication (MFA) and we&rsquo;re (hopefully) using it everywhere: Twitter, Gmail, Slack, etc. On the other hand, we don&rsquo;t usually use it for our infrastructure access. RDP, SSH, Telnet are among those services that are not easy to secure on the open internet, so we usually tuck them away under a bastion host or a &ldquo;gateway&rdquo; of sorts that can provide this MFA functionality.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.n0p.me/2020/09/2020-09-28-sshmfahook/"><meta property="og:image" content="https://blog.n0p.me/author.jpg"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2020-09-28T00:00:00+00:00">
<meta property="article:modified_time" content="2020-09-28T00:00:00+00:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://blog.n0p.me/author.jpg">
<meta name=twitter:title content="SSH MFA using Slack/Teams/Discord">
<meta name=twitter:description content="What is SSH MFA Let&rsquo;s start from the basics. We&rsquo;re all familiar with Multi-Factor Authentication (MFA) and we&rsquo;re (hopefully) using it everywhere: Twitter, Gmail, Slack, etc. On the other hand, we don&rsquo;t usually use it for our infrastructure access. RDP, SSH, Telnet are among those services that are not easy to secure on the open internet, so we usually tuck them away under a bastion host or a &ldquo;gateway&rdquo; of sorts that can provide this MFA functionality.">
<meta name=application-name content="n0p Blog">
<meta name=apple-mobile-web-app-title content="n0p Blog"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.n0p.me/2020/09/2020-09-28-sshmfahook/><link rel=prev href=https://blog.n0p.me/2020/08/2020-08-15-analysing-big-pcap/><link rel=next href=https://blog.n0p.me/2020/10/2020-10-13-malware-applocker-bypass/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"SSH MFA using Slack/Teams/Discord","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.n0p.me\/2020\/09\/2020-09-28-sshmfahook\/"},"genre":"posts","keywords":"linux, ssh, mfa","wordcount":925,"url":"https:\/\/blog.n0p.me\/2020\/09\/2020-09-28-sshmfahook\/","datePublished":"2020-09-28T00:00:00+00:00","dateModified":"2020-09-28T00:00:00+00:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"Ali Mosajjal"},"author":{"@type":"Person","name":"Ali Mosajjal"},"description":""}</script></head>
<body header-desktop header-mobile><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':''==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:''==='dark')&&document.body.setAttribute('theme','dark')</script>
<div id=mask></div><div class=wrapper><header class=desktop id=header-desktop>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="n0p Blog">n0p Blog</a>
</div>
<div class=menu>
<div class=menu-inner><a class=menu-item href=/posts> Posts </a><a class=menu-item href=/tags> Tags </a><a class=menu-item href=/categories> Categories </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search>
<i class="fas fa-search fa-fw"></i>
</a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear>
<i class="fas fa-times-circle fa-fw"></i>
</a>
<span class="search-button search-loading" id=search-loading-desktop>
<i class="fas fa-spinner fa-fw fa-spin"></i>
</span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i>
</a>
</div>
</div>
</div>
</header><header class=mobile id=header-mobile>
<div class=header-container>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="n0p Blog">n0p Blog</a>
</div>
<div class=menu-toggle id=menu-toggle-mobile>
<span></span><span></span><span></span>
</div>
</div>
<div class=menu id=menu-mobile><div class=search-wrapper>
<div class="search mobile" id=search-mobile>
<input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search>
<i class="fas fa-search fa-fw"></i>
</a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear>
<i class="fas fa-times-circle fa-fw"></i>
</a>
<span class="search-button search-loading" id=search-loading-mobile>
<i class="fas fa-spinner fa-fw fa-spin"></i>
</span>
</div>
<a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>
Cancel
</a>
</div><a class=menu-item href=/posts title>Posts</a><a class=menu-item href=/tags title>Tags</a><a class=menu-item href=/categories title>Categories</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i>
</a></div>
</div>
</header>
<div class="search-dropdown desktop">
<div id=search-dropdown-desktop></div>
</div>
<div class="search-dropdown mobile">
<div id=search-dropdown-mobile></div>
</div>
<main class=main>
<div class=container><div class=toc id=toc-auto>
<h2 class=toc-title>Contents</h2>
<div class=toc-content id=toc-content-auto></div>
</div><article class="page single"><h1 class="single-title animated flipInX">SSH MFA using Slack/Teams/Discord</h1><div class=post-meta>
<div class=post-meta-line><span class=post-author><a href=/ title=Author rel=" author" class=author><i class="fas fa-user-circle fa-fw"></i>Ali Mosajjal</a></span>&nbsp;<span class=post-category>included in <a href=/categories/linux/><i class="far fa-folder fa-fw"></i>Linux</a>&nbsp;<a href=/categories/security/><i class="far fa-folder fa-fw"></i>security</a></span></div>
<div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2020-09-28>2020-09-28</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;925 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;5 minutes&nbsp;</div>
</div><div class="details toc" id=toc-static kept>
<div class="details-summary toc-title">
<span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span>
</div>
<div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents></nav></div>
</div><div class=content id=content><h1 id=what-is-ssh-mfa>What is SSH MFA</h1>
<p>Let&rsquo;s start from the basics. We&rsquo;re all familiar with Multi-Factor Authentication (MFA) and we&rsquo;re (hopefully) using it everywhere: Twitter, Gmail, Slack, etc. On the other hand, we don&rsquo;t usually use it for our infrastructure access. RDP, SSH, Telnet are among those services that are not easy to secure on the open internet, so we usually tuck them away under a bastion host or a &ldquo;gateway&rdquo; of sorts that can provide this MFA functionality. Unfortunately, those services are quite expensive and according to Shodan, we have ~23 MILLION SSH servers exposed to the open internet. Those services might not be any of my concern now, but when (not if) they&rsquo;re compromised, they&rsquo;re gonna form a zombie army for a botnet and then it becomes everyone&rsquo;s problem.</p>
<p>To that end, I decided to do a cost-benefit analysis of different methods to secure a SSH server exposed to the Internet. We covered the first and more cumbersome logical answer: using gateways and bastions. The next step, which has been around for years and it&rsquo;s working quite well, is authentication using SSH keypair. SSH keys don&rsquo;t allow interactive logins altogether and use a keypair to authenticate a user. It&rsquo;s been around for ages and it works really really well. I can&rsquo;t recommend it enough! But, in practice, even if the server is configured to authenticate using SSH key, it&rsquo;s not always enforced and the user can just log on using a regular password. There&rsquo;s also always a risk of key-sharing between the team members within the organization. So having a second factor still makes a lot of sense.</p>
<h1 id=why-webhook>Why Webhook</h1>
<p>Ideally, the second factor of any authentication shouldn&rsquo;t use the medium that the first factor is using. eg having MFA sent over the internet still means we trust the internet and TLS/PKI. There are several protocols that implement an agreed timestamped approach with the key sync happening only once at the start of the key exchange, and there&rsquo;s no need for the &ldquo;comms&rdquo; to happen outside of that short period of time. The main implementation of this protocol is RFC 6238 (TOTP). TOTP is used quite extensively to build MFA. Google Authenticator, Lastpass Authenticator, Cisco Duo and Microsoft Auth all support RFC6238. But there are two main drawbacks of using this in a shared production environment</p>
<ul>
<li>Losing your private key means losing your access. If you drop your phone in the toilet, no SSH for you until you console back into the machine and re-configure the keys with your new phone</li>
<li>Definitely not ideal for teams. One key is for one user and one user only. there&rsquo;s no good way to share the key between teams and have audit in place for everyone.</li>
</ul>
<p>As I mentioned before, having a &ldquo;shared&rdquo; environment is not ideal at all. It&rsquo;s not the best practice and it&rsquo;s not recommended at all. But in reality it happens more often than not, especially in staging/testing instances. This is where making those corner-cases secure becomes important, and this is where Webhooks come into play.</p>
<p>Webhook MFA offers a simple yet effective MFA solution. in your team, you probably have a strict Slack/Teams Authentication policy. Enorced MFA, short session timeouts and managing sessions per device are easily possible with the current collaboration tools. All your comms are already in a centralized place, why not have a channel for your SSH MFA tokens and make them accessible to everyone, keep a log of which IP is trying to access which server at which time and more importantly, share this within a team rather than having it per individual?</p>
<h1 id=implementation-details>Implementation details</h1>
<p>The implementation is actually pretty simple. The PAM module is a single <code>.c</code> file that compiles into a shared object (<code>.so</code>) that can be used in <code>auth</code> section of PAM. The <code>.so</code> file needs an ini configuration file path as an argument to make it as customizable as possible. The ini file has the URL, the JSON data, the details of how many digits should each OTA code be as well as a very simple template engine to make sure the message send to your work collaboration tool is suited to what you need. When an authentication attempt happen, depending on your <code>/etc/pam.d/sshd</code> config, you can put this authentication factor wherever in the process. I recommend putting it as a last step in auth process, especially for the internet-facing servers otherwise the spam in your Slack channel will be real! For internal-facing servers, you might consider putting this factor of auth in the beginning of the auth process just to make it more audit-able from your point of view, since internal servers are not meant to be touched/accessed all the time anyway.</p>
<p>You can also configure <code>sshd</code> to ignore this factor of auth when you&rsquo;re logging in via SSH keys. That&rsquo;s customizable through <code>sshd</code> conf and it&rsquo;s covered in this amazing doc from <a href=https://wiki.archlinux.org/index.php/OpenSSH#Two-factor_authentication_and_public_keys target=_blank rel="noopener noreffer">Arch Wiki</a>.</p>
<p>I&rsquo;ve covered a bit of configuration and implementation details within the <a href=https://github.com/mosajjal/webhookpam/blob/master/README.md target=_blank rel="noopener noreffer">project README</a> as well.</p>
<h1 id=declaimer>Declaimer</h1>
<p>Big Disclaimer: This project is at beta at best. Be careful with it otherwise you&rsquo;ll lock yourself out! you can take a look at PAM&rsquo;s <code>optional</code> module for this just to do some stress tests in different scenarios and see if it works first before pushing it to your prod instances. There are also a lot of error control and bits and pieces missing from the implementation. Feel free to raise any issues to the <a href=https://github.com/mosajjal/webhookpam target=_blank rel="noopener noreffer">Github repo</a> so we can work together to fix them and make this a viable option for everyone.</p>
</div><div class=post-footer id=post-footer>
<div class=post-info>
<div class=post-info-line>
<div class=post-info-mod>
<span>Updated on 2020-09-28</span>
</div>
<div class=post-info-license></div>
</div>
<div class=post-info-line>
<div class=post-info-md></div>
<div class=post-info-share>
<span></span>
</div>
</div>
</div>
<div class=post-info-more>
<section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/linux/>linux</a>,&nbsp;<a href=/tags/ssh/>ssh</a>,&nbsp;<a href=/tags/mfa/>mfa</a></section>
<section>
<span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span>
</section>
</div>
<div class=post-nav><a href=/2020/08/2020-08-15-analysing-big-pcap/ class=prev rel=prev title="Parsing a massive DNS PCAP file efficiently"><i class="fas fa-angle-left fa-fw"></i>Parsing a massive DNS PCAP file efficiently</a>
<a href=/2020/10/2020-10-13-malware-applocker-bypass/ class=next rel=next title="Analysis of a Multi-stage Squiblydoo variant">Analysis of a Multi-stage Squiblydoo variant<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id=comments><div id=disqus_thread class=comment></div><noscript>
Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.
</noscript></div></article></div>
</main><footer class=footer>
<div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.87.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
</div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2021</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Ali Mosajjal</a></span></div>
</div>
</footer></div>
<div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top">
<i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments">
<i class="fas fa-comment fa-fw"></i>
</a>
</div><script type=text/javascript src=https://n0p-me.disqus.com/embed.js defer></script><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{},search:{highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:30}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-114664513-1',{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=UA-114664513-1" async></script></body>
</html>